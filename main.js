/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

var D=Object.defineProperty;var Q=Object.getOwnPropertyDescriptor;var Z=Object.getOwnPropertyNames;var tt=Object.prototype.hasOwnProperty;var et=(s,i)=>{for(var t in i)D(s,t,{get:i[t],enumerable:!0})},nt=(s,i,t,n)=>{if(i&&typeof i=="object"||typeof i=="function")for(let e of Z(i))!tt.call(s,e)&&e!==t&&D(s,e,{get:()=>i[e],enumerable:!(n=Q(i,e))||n.enumerable});return s};var it=s=>nt(D({},"__esModule",{value:!0}),s);var ot={};et(ot,{default:()=>$});module.exports=it(ot);var z=require("obsidian");var E=require("obsidian"),M={apiKey:"",model:"gemini-2.5-flash",storeName:"",storeDisplayName:"obsidian-vault"},I=class extends E.PluginSettingTab{constructor(i,t){super(i,t),this.plugin=t}display(){let{containerEl:i}=this;i.empty(),new E.Setting(i).setName("API key").setDesc("Gemini API key. This plugin sends note contents to google for indexing and answers.").addText(t=>{t.inputEl.type="password",t.setPlaceholder("API key").setValue(this.plugin.settings.apiKey).onChange(async n=>{this.plugin.settings.apiKey=n.trim(),await this.plugin.saveSettings()})}),new E.Setting(i).setName("Model").setDesc("Model used for answering queries.").addText(t=>t.setValue(this.plugin.settings.model).onChange(async n=>{this.plugin.settings.model=n.trim(),await this.plugin.saveSettings()})),new E.Setting(i).setName("File search store name").setDesc("Full resource name").addText(t=>t.setValue(this.plugin.settings.storeName).onChange(async n=>{this.plugin.settings.storeName=n.trim(),await this.plugin.saveSettings()})),new E.Setting(i).setName("Store display name").setDesc("Used when creating a new store from the command palette.").addText(t=>t.setValue(this.plugin.settings.storeDisplayName).onChange(async n=>{this.plugin.settings.storeDisplayName=n.trim(),await this.plugin.saveSettings()})),new E.Setting(i).setName("Reset local index state").setDesc("Clears local index tracking. This does not delete remote documents.").addButton(t=>t.setButtonText("Reset").onClick(async()=>{await this.plugin.resetIndexState()}))}};var v=require("obsidian");var j=require("obsidian"),R="https://generativelanguage.googleapis.com/v1beta",st="https://generativelanguage.googleapis.com/upload/v1beta",k=class{constructor(i){this.apiKey=i}async createFileSearchStore(i){return await this.request(`${R}/fileSearchStores`,{method:"POST",body:JSON.stringify({displayName:i})})}async deleteFileSearchStore(i,t=!0){let n=new URL(`${R}/${i}`);t&&n.searchParams.set("force","true"),await this.request(n.toString(),{method:"DELETE"})}async uploadMarkdownToStore(i,t){let n=await fetch(`${st}/${i}:uploadToFileSearchStore`,{method:"POST",headers:{"x-goog-api-key":this.apiKey,"X-Goog-Upload-Protocol":"resumable","X-Goog-Upload-Command":"start","X-Goog-Upload-Header-Content-Length":String(t.bytes.byteLength),"X-Goog-Upload-Header-Content-Type":"text/markdown","Content-Type":"application/json"},body:JSON.stringify({displayName:t.displayName,mimeType:"text/markdown",customMetadata:t.metadata})});if(!n.ok)throw new Error(`Upload start failed: ${await n.text()}`);let e=n.headers.get("x-goog-upload-url");if(!e)throw new Error("Upload URL missing from response.");let r=await fetch(e,{method:"POST",headers:{"X-Goog-Upload-Command":"upload, finalize","X-Goog-Upload-Offset":"0"},body:new Blob([t.bytes.slice().buffer],{type:"text/markdown"})});if(!r.ok)throw new Error(`Upload finalize failed: ${await r.text()}`);return await r.json()}async waitForOperation(i,t=12e4){var e;let n=Date.now();for(;Date.now()-n<t;){let r=await this.request(`${R}/${i}`,{method:"GET"});if(r.done){if((e=r.error)!=null&&e.message)throw new Error(r.error.message);return}await this.delay(1e3)}throw new Error("Indexing timed out.")}async generateContent(i,t,n,e=[],r){let a=[];for(let o of e)a.push({role:"user",parts:[{text:o.question}]}),a.push({role:"model",parts:[{text:o.answer}]});return a.push({role:"user",parts:[{text:n}]}),await this.request(`${R}/models/${i}:generateContent`,{method:"POST",body:JSON.stringify({contents:a,tools:[{fileSearch:{fileSearchStoreNames:[t]}}],generationConfig:r?{thinkingConfig:{includeThoughts:!0}}:void 0})})}async generateContentStream(i,t,n,e,r=[],a){var w;let o=[];for(let l of r)o.push({role:"user",parts:[{text:l.question}]}),o.push({role:"model",parts:[{text:l.answer}]});o.push({role:"user",parts:[{text:n}]});let c=await fetch(`${R}/models/${i}:streamGenerateContent?alt=sse`,{method:"POST",headers:{"x-goog-api-key":this.apiKey,"Content-Type":"application/json"},body:JSON.stringify({contents:o,tools:[{fileSearch:{fileSearchStoreNames:[t]}}],generationConfig:a?{thinkingConfig:{includeThoughts:!0}}:void 0})});if(!c.ok||!c.body)throw new Error(await c.text());let u=c.body.getReader(),d=new TextDecoder,h="";for(;;){let{done:l,value:m}=await u.read();if(l)break;let g=d.decode(m,{stream:!0});h+=g;let f=h.split(`
`);h=(w=f.pop())!=null?w:"";for(let p of f)if(p.startsWith("data: ")){let y=p.slice(6);try{let x=JSON.parse(y);await e(x)}catch(x){console.error("Failed to parse stream chunk",x)}}}}extractAnswer(i){var u,d,h,w,l;let t=(u=i.candidates)==null?void 0:u[0],n=(h=(d=t==null?void 0:t.content)==null?void 0:d.parts)!=null?h:[],e=[],r=[];for(let m of n){let g=(w=m.text)!=null?w:"";g&&(m.thought?e.push(g):r.push(g))}let a=r.join(""),o=e.join(""),c=(l=t==null?void 0:t.groundingMetadata)!=null?l:t==null?void 0:t.grounding_metadata;return{text:a,grounding:c,thoughtSummary:o||void 0}}async request(i,t){let n={url:i,method:t.method,headers:{"x-goog-api-key":this.apiKey,"Content-Type":"application/json"},body:t.body,throw:!1},e=await(0,j.requestUrl)(n);if(e.status>=400)throw new Error(e.text);return e.status===204?{}:e.json}async delay(i){return new Promise(t=>window.setTimeout(t,i))}};var A=require("obsidian");function rt(s){var i,t;return(t=(i=s.stat)==null?void 0:i.mtime)!=null?t:0}async function O(s){var a,o;let i=s.settings.apiKey,t=s.settings.storeName;if(!i){new A.Notice("API key is not set.");return}if(!t){new A.Notice("File search store name is not set.");return}s.indexState.storeName!==t&&await s.resetIndexStateForStore(t);let n=s.app.vault.getMarkdownFiles(),e=new k(i),r={total:n.length,indexed:0,skipped:0};s.setStatus(`Indexing ${n.length} files...`);for(let c of n){let u=rt(c),d=(o=(a=s.indexState.files[c.path])==null?void 0:a.mtime)!=null?o:0;if(u<=d){r.skipped+=1;continue}try{let h=await at(s,e,t,c,u);h!=null&&h.name&&await e.waitForOperation(h.name),s.indexState.files[c.path]={mtime:u},r.indexed+=1,s.setStatus(`Indexed ${r.indexed}/${r.total} (skipped ${r.skipped})`),await s.saveSettings()}catch(h){console.error(h),new A.Notice(`Failed to index ${c.path}`)}}s.setStatus(`Index complete. Indexed ${r.indexed}, skipped ${r.skipped}.`),new A.Notice(`Index complete. Indexed ${r.indexed}, skipped ${r.skipped}.`)}async function at(s,i,t,n,e){let r=await s.app.vault.read(n),a=new TextEncoder().encode(r);if(a.byteLength>100*1024*1024)throw new Error(`File too large: ${n.path}`);let o=[{key:"vault",stringValue:s.app.vault.getName()},{key:"path",stringValue:n.path},{key:"mtime",numericValue:e}];return await i.uploadMarkdownToStore(t,{displayName:n.path,bytes:a,metadata:o})}var L=require("obsidian");async function F(s){var e,r;let i=s.settings.apiKey;if(!i){new L.Notice("API key is not set.");return}let t=s.settings.storeDisplayName||"obsidian-vault",n=new k(i);try{s.settings.storeName&&(s.setStatus("Deleting existing File Search store..."),await n.deleteFileSearchStore(s.settings.storeName,!0)),s.setStatus("Creating File Search store...");let a=await n.createFileSearchStore(t);s.settings.storeName=(e=a.name)!=null?e:"",await s.resetIndexStateForStore(s.settings.storeName),await s.saveSettings(),new L.Notice(`Store created: ${(r=a.name)!=null?r:"unknown"}`)}catch(a){console.error(a),new L.Notice("Failed to create store. Check console for details.")}finally{s.setStatus("")}}function G(s,i){return s!=null&&s.groundingChunks?s.groundingChunks.map((t,n)=>{var h,w,l,m,g;let e=(h=t.retrievedContext)!=null?h:t.retrieved_context,r=(l=(w=e==null?void 0:e.title)!=null?w:e==null?void 0:e.displayName)!=null?l:e==null?void 0:e.display_name,a=(m=e==null?void 0:e.uri)!=null?m:e==null?void 0:e.uri,o=(g=e==null?void 0:e.text)!=null?g:e==null?void 0:e.text,c=r||a||`Chunk ${n+1}`,u=o?o.slice(0,200):void 0,d=i(r);return{label:c,detail:u,path:d,uri:a,index:n+1,text:o}}):[]}function U(s,i,t){var o,c,u,d,h,w;if(!i)return s;let n=(c=(o=i.groundingSupports)!=null?o:i.grounding_supports)!=null?c:[];if(n.length===0)return s;let e=new Map;for(let l of n){let m=(u=l.segment)!=null?u:l.segment,g=(d=m==null?void 0:m.endIndex)!=null?d:m==null?void 0:m.end_index,f=(h=l.groundingChunkIndices)!=null?h:l.grounding_chunk_indices;if(typeof g!="number"||!Array.isArray(f))continue;let p=f.map(S=>{var b;return(b=t[S])==null?void 0:b.index}).filter(S=>typeof S=="number");if(p.length===0)continue;let y=Array.from(new Set(p)).sort((S,b)=>S-b),x=(w=e.get(g))!=null?w:[];e.set(g,x.concat(y))}if(e.size===0)return s;let r=[];for(let[l,m]of e.entries()){let f=Array.from(new Set(m)).sort((p,y)=>p-y).map(p=>`[${p}](citation:${p})`).join(" ");r.push({pos:l,marker:f})}r.sort((l,m)=>m.pos-l.pos);let a=s;for(let l of r)l.pos>=0&&l.pos<=a.length?a=a.slice(0,l.pos)+l.marker+a.slice(l.pos):a+=l.marker;return a}var H=require("obsidian");function q(s,i){if(!i)return;if(s.vault.getAbstractFileByPath(i))return i;let n=i.replace(/\.md$/i,""),e=s.vault.getFiles();for(let r of e)if(r.basename===n)return r.path}async function W(s,i){if(i.path){let t=s.vault.getAbstractFileByPath(i.path);if(t instanceof H.TFile){await s.workspace.getLeaf(!0).openFile(t);return}}i.uri&&window.open(i.uri,"_blank")}var T="gemini-file-search-rag-view",C=class extends v.ItemView{constructor(t,n){super(t);this.sourcesMap=new Map;this.plugin=n}getViewType(){return T}getDisplayText(){return"Obsidian agent"}async onOpen(){this.render()}render(){let{contentEl:t}=this;t.empty(),t.addClass("gemini-rag-view");let n=t.createEl("div",{cls:"gemini-rag-header"});n.createEl("div",{cls:"gemini-rag-title-wrap"}).createEl("h2",{text:"Obsidian agent"});let a=n.createEl("div",{cls:"gemini-rag-header-actions"}).createEl("button",{cls:"gemini-rag-icon-btn",attr:{"aria-label":"New chat",title:"New chat"}});(0,v.setIcon)(a,"plus-circle");let o=t.createEl("div",{cls:"gemini-rag-main"});this.chatEl=o.createEl("div",{cls:"gemini-rag-chat"}),this.chatEl.addEventListener("click",g=>{let f=g.target;if(!f)return;let p=f.closest("a");if(!p)return;let y=p.getAttribute("href");if(!y||!y.startsWith("citation:"))return;g.preventDefault();let x=y.replace("citation:",""),S=Number(x);if(!Number.isFinite(S))return;let b=this.sourcesMap.get(S);b&&W(this.app,b)}),this.chatEl.addEventListener("mouseover",g=>{let f=g.target;if(!f)return;let p=f.closest("a");if(!p)return;let y=p.getAttribute("href");if(!y||!y.startsWith("citation:"))return;let x=y.replace("citation:",""),S=Number(x);if(!Number.isFinite(S))return;let b=this.sourcesMap.get(S);b&&this.showTooltip(p,b)}),this.chatEl.addEventListener("mouseout",g=>{let f=g.target;if(!f)return;let p=f.closest("a");if(!p)return;let y=p.getAttribute("href");!y||!y.startsWith("citation:")||this.hideTooltip()}),this.renderHistory();let c=t.createEl("div",{cls:"gemini-rag-controls"}),u=c.createEl("textarea",{cls:"gemini-rag-input",attr:{rows:"5",placeholder:"Ask something about your notes..."}});this.hintEl=c.createEl("div",{cls:"gemini-rag-hint"}),this.hintEl.setText("\u2318/Ctrl + Enter \u3067\u9001\u4FE1");let d=c.createEl("div",{cls:"gemini-rag-buttons"}),h=d.createEl("button",{cls:"gemini-rag-btn is-primary",text:"Ask"}),w=d.createEl("button",{cls:"gemini-rag-btn",text:"Index vault"}),l=d.createEl("button",{cls:"gemini-rag-btn",text:"Create store"}),m=async()=>{let g=u.value.trim();g&&(u.value="",await this.ask(g))};a.addEventListener("click",()=>{this.clearChat()}),h.addEventListener("click",()=>{m()}),u.addEventListener("keydown",g=>{(g.metaKey||g.ctrlKey)&&g.key==="Enter"&&(g.preventDefault(),m())}),w.addEventListener("click",()=>{O(this.plugin)}),l.addEventListener("click",()=>{F(this.plugin)})}async clearChat(){this.plugin.history=[],await this.plugin.saveSettings(),this.sourcesMap.clear(),this.renderHistory()}async ask(t){let n=this.plugin.settings.apiKey,e=this.plugin.settings.storeName,r=this.plugin.settings.model;if(!n){new v.Notice("API key is not set.");return}if(!e){new v.Notice("File search store name is not set.");return}let a=new k(n);try{this.plugin.setStatus("Generating answer...");let o=this.plugin.history.slice(-10),c="",u="",d;if(!this.chatEl)return;this.chatEl.createEl("div",{cls:"gemini-rag-chat-bubble user"}).createEl("div",{cls:"gemini-rag-chat-text",text:t}),this.scrollToBottom();let l=this.chatEl.createEl("div",{cls:"gemini-rag-chat-bubble assistant"}).createEl("div",{cls:"gemini-rag-chat-text"});await a.generateContentStream(r,e,t,async p=>{var _,B,V,K;let{text:y,grounding:x,thoughtSummary:S}=a.extractAnswer(p);y&&(c+=y),S&&(u+=S),x&&(d={...d,...x,groundingChunks:[...(_=d==null?void 0:d.groundingChunks)!=null?_:[],...(B=x.groundingChunks)!=null?B:[]],groundingSupports:[...(V=d==null?void 0:d.groundingSupports)!=null?V:[],...(K=x.groundingSupports)!=null?K:[]]});let b=U(c,d,G(d,()=>"")),Y=this.formatOutput(b,u,!1);l.empty(),await v.MarkdownRenderer.render(this.plugin.app,Y,l,this.plugin.app.vault.getRoot().path,this),this.scrollToBottom()},o,!0);let m=G(d,p=>q(this.app,p));this.sourcesMap.clear();for(let p of m)this.sourcesMap.set(p.index,p);let g=U(c,d,m),f=this.formatOutput(g,u,!0);l.empty(),await v.MarkdownRenderer.render(this.plugin.app,f,l,this.plugin.app.vault.getRoot().path,this),this.scrollToBottom(),this.pushHistory(t,f)}catch(o){console.error(o),new v.Notice("Failed to generate answer. Check console for details.")}finally{this.plugin.setStatus("")}}formatOutput(t,n,e=!1){let r="Thinking...";e?r="\u63A8\u8AD6\u5B8C\u4E86":n&&(r=this.getLatestThoughtTitle(n));let a=`> [!info] ${r}`;return t.trim()?`${a}

${t}`:a}getLatestThoughtTitle(t){if(!t)return"Thinking...";let n=t.split(`
`).map(o=>o.trim()).filter(o=>o.length>0),e=n[n.length-1];if(!e)return"Thinking...";let r=e.replace(/^#+\s*/,"").replace(/^[-*]\s+/,"").replace(/^>\s+/,""),a=50;return r.length>a?r.substring(0,a)+"...":r}pushHistory(t,n){let e={id:`${Date.now()}-${Math.random().toString(16).slice(2)}`,timestamp:Date.now(),question:t,answer:n},r=50;this.plugin.history.push(e),this.plugin.history.length>r&&(this.plugin.history=this.plugin.history.slice(-r)),this.plugin.saveSettings()}renderHistory(){if(this.chatEl){if(this.chatEl.empty(),!this.plugin.history.length){this.chatEl.createEl("div",{cls:"gemini-rag-chat-empty",text:"No messages yet."});return}for(let t of this.plugin.history){this.chatEl.createEl("div",{cls:"gemini-rag-chat-bubble user"}).createEl("div",{cls:"gemini-rag-chat-text",text:t.question});let r=this.chatEl.createEl("div",{cls:"gemini-rag-chat-bubble assistant"}).createEl("div",{cls:"gemini-rag-chat-text"});v.MarkdownRenderer.render(this.plugin.app,t.answer,r,this.plugin.app.vault.getRoot().path,this)}this.scrollToBottom()}}showTooltip(t,n){this.hideTooltip();let e=document.createElement("div");e.className="gemini-rag-tooltip";let r=e.createEl("div",{cls:"gemini-rag-tooltip-header"});if(r.createEl("span",{cls:"gemini-rag-tooltip-icon",text:"\u{1F4C4}"}),r.createEl("span",{cls:"gemini-rag-tooltip-title",text:n.label}),n.text){let d=n.text.slice(0,150).trim(),h=d.length<n.text.length?d+"...":d;e.createEl("div",{cls:"gemini-rag-tooltip-body",text:h})}else n.detail&&e.createEl("div",{cls:"gemini-rag-tooltip-body",text:n.detail});document.body.appendChild(e),this.tooltipEl=e;let a=t.getBoundingClientRect(),o=e.getBoundingClientRect(),c=a.left+a.width/2-o.width/2,u=a.bottom+8;c<8&&(c=8),c+o.width>window.innerWidth-8&&(c=window.innerWidth-o.width-8),u+o.height>window.innerHeight-8&&(u=a.top-o.height-8),e.style.left=`${c}px`,e.style.top=`${u}px`}hideTooltip(){this.tooltipEl&&(this.tooltipEl.remove(),this.tooltipEl=void 0)}scrollToBottom(){this.chatEl&&(this.chatEl.scrollTop=this.chatEl.scrollHeight)}};async function P(s){let{workspace:i}=s.app,t=i.getLeavesOfType(T)[0];if(!t){let n=i.getRightLeaf(!1);t=n!=null?n:void 0,t||(t=i.getLeaf(!1)),await t.setViewState({type:T,active:!0})}await i.revealLeaf(t)}async function X(s){await P(s);let i=s.app.workspace.getLeavesOfType(T);if(i.length===0){s.history=[],await s.saveSettings();return}for(let t of i){let n=t.view;n instanceof C&&await n.clearChat()}}function J(s){s.addCommand({id:"open-gemini-rag-panel",name:"Open panel",callback:()=>P(s)}),s.addCommand({id:"new-chat",name:"New chat",callback:()=>X(s)}),s.addCommand({id:"index-vault-to-file-search",name:"Index vault to file search",callback:()=>O(s)}),s.addCommand({id:"create-file-search-store",name:"Create file search store",callback:()=>F(s)})}var N={version:1,files:{}};var $=class extends z.Plugin{constructor(){super(...arguments);this.statusListeners=new Set}async onload(){await this.loadSettings(),this.registerView(T,t=>new C(t,this)),this.addSettingTab(new I(this.app,this)),J(this),this.app.workspace.onLayoutReady(()=>{P(this)})}setStatus(t){for(let n of this.statusListeners)n(t)}onStatusChange(t){return this.statusListeners.add(t),()=>{this.statusListeners.delete(t)}}async loadSettings(){var n,e;let t=await this.loadData();if(t&&"settings"in t)this.settings=Object.assign({},M,(n=t.settings)!=null?n:{}),this.indexState=Object.assign({},N,(e=t.indexState)!=null?e:{}),this.history=Array.isArray(t.history)?t.history:[];else{let r=t!=null?t:{};this.settings=Object.assign({},M,r),this.indexState=Object.assign({},N),this.history=[]}}async saveSettings(){let t={settings:this.settings,indexState:this.indexState,history:this.history};await this.saveData(t)}async resetIndexState(){this.indexState=Object.assign({},N),await this.saveSettings()}async resetIndexStateForStore(t){this.indexState=Object.assign({},N,{storeName:t}),await this.saveSettings()}};
