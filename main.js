/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

var U=Object.defineProperty;var K=Object.getOwnPropertyDescriptor;var H=Object.getOwnPropertyNames;var q=Object.prototype.hasOwnProperty;var j=(a,n)=>{for(var e in n)U(a,e,{get:n[e],enumerable:!0})},W=(a,n,e,t)=>{if(n&&typeof n=="object"||typeof n=="function")for(let i of H(n))!q.call(a,i)&&i!==e&&U(a,i,{get:()=>n[i],enumerable:!(t=K(n,i))||t.enumerable});return a};var X=a=>W(U({},"__esModule",{value:!0}),a);var Q={};j(Q,{default:()=>$});module.exports=X(Q);var B=require("obsidian");var y=require("obsidian"),V={apiKey:"",model:"gemini-2.5-flash",storeName:"",storeDisplayName:"obsidian-vault",metadataFilter:"",chunkingEnabled:!0,maxTokensPerChunk:200,maxOverlapTokens:20},I=class extends y.PluginSettingTab{constructor(n,e){super(n,e),this.plugin=e}display(){let{containerEl:n}=this;n.empty(),n.createEl("h2",{text:"Gemini RAG settings"}),new y.Setting(n).setName("API key").setDesc("Gemini API key. This plugin sends note contents to Google for indexing and answers.").addText(e=>{e.inputEl.type="password",e.setPlaceholder("AI Studio API key").setValue(this.plugin.settings.apiKey).onChange(async t=>{this.plugin.settings.apiKey=t.trim(),await this.plugin.saveSettings()})}),new y.Setting(n).setName("Model").setDesc("Model used for answering queries.").addText(e=>e.setPlaceholder("gemini-2.5-flash").setValue(this.plugin.settings.model).onChange(async t=>{this.plugin.settings.model=t.trim(),await this.plugin.saveSettings()})),new y.Setting(n).setName("File Search store name").setDesc("Full resource name, for example: fileSearchStores/1234567890").addText(e=>e.setPlaceholder("fileSearchStores/...").setValue(this.plugin.settings.storeName).onChange(async t=>{this.plugin.settings.storeName=t.trim(),await this.plugin.saveSettings()})),new y.Setting(n).setName("Store display name").setDesc("Used when creating a new store from the command palette.").addText(e=>e.setPlaceholder("obsidian-vault").setValue(this.plugin.settings.storeDisplayName).onChange(async t=>{this.plugin.settings.storeDisplayName=t.trim(),await this.plugin.saveSettings()})),new y.Setting(n).setName("Metadata filter").setDesc('Optional: filter sources by metadata (AIP-160 syntax). Example: author="Alice"').addText(e=>e.setPlaceholder('author="Alice"').setValue(this.plugin.settings.metadataFilter).onChange(async t=>{this.plugin.settings.metadataFilter=t.trim(),await this.plugin.saveSettings()})),new y.Setting(n).setName("Chunking config").setDesc("Use custom chunk sizes for File Search indexing (white-space chunking).").addToggle(e=>e.setValue(this.plugin.settings.chunkingEnabled).onChange(async t=>{this.plugin.settings.chunkingEnabled=t,await this.plugin.saveSettings()})),new y.Setting(n).setName("Max tokens per chunk").setDesc("Used when chunking is enabled. Default is 200.").addText(e=>e.setPlaceholder("200").setValue(String(this.plugin.settings.maxTokensPerChunk)).onChange(async t=>{let i=Number.parseInt(t,10);!Number.isNaN(i)&&i>0&&(this.plugin.settings.maxTokensPerChunk=i,await this.plugin.saveSettings())})),new y.Setting(n).setName("Max overlap tokens").setDesc("Used when chunking is enabled. Default is 20.").addText(e=>e.setPlaceholder("20").setValue(String(this.plugin.settings.maxOverlapTokens)).onChange(async t=>{let i=Number.parseInt(t,10);!Number.isNaN(i)&&i>=0&&(this.plugin.settings.maxOverlapTokens=i,await this.plugin.saveSettings())})),new y.Setting(n).setName("Reset local index state").setDesc("Clears local index tracking. This does not delete remote documents.").addButton(e=>e.setButtonText("Reset").onClick(async()=>{await this.plugin.resetIndexState()}))}};var m=require("obsidian");var O="https://generativelanguage.googleapis.com/v1beta",z="https://generativelanguage.googleapis.com/upload/v1beta",x=class{constructor(n){this.apiKey=n}async createFileSearchStore(n){return await this.request(`${O}/fileSearchStores`,{method:"POST",body:JSON.stringify({displayName:n})})}async deleteFileSearchStore(n,e=!0){let t=new URL(`${O}/${n}`);e&&t.searchParams.set("force","true"),await this.request(t.toString(),{method:"DELETE"})}async uploadMarkdownToStore(n,e){let t=await fetch(`${z}/${n}:uploadToFileSearchStore`,{method:"POST",headers:{"x-goog-api-key":this.apiKey,"X-Goog-Upload-Protocol":"resumable","X-Goog-Upload-Command":"start","X-Goog-Upload-Header-Content-Length":String(e.bytes.byteLength),"X-Goog-Upload-Header-Content-Type":"text/markdown","Content-Type":"application/json"},body:JSON.stringify({displayName:e.displayName,mimeType:"text/markdown",chunkingConfig:e.chunking?{whiteSpaceConfig:{maxTokensPerChunk:e.chunking.maxTokensPerChunk,maxOverlapTokens:e.chunking.maxOverlapTokens}}:void 0,customMetadata:e.metadata})});if(!t.ok)throw new Error(`Upload start failed: ${await t.text()}`);let i=t.headers.get("x-goog-upload-url");if(!i)throw new Error("Upload URL missing from response.");let s=await fetch(i,{method:"POST",headers:{"X-Goog-Upload-Command":"upload, finalize","X-Goog-Upload-Offset":"0"},body:e.bytes});if(!s.ok)throw new Error(`Upload finalize failed: ${await s.text()}`);return await s.json()}async waitForOperation(n,e=12e4){var i;let t=Date.now();for(;Date.now()-t<e;){let s=await this.request(`${O}/${n}`,{method:"GET"});if(s.done){if((i=s.error)!=null&&i.message)throw new Error(s.error.message);return}await this.delay(1e3)}throw new Error("Indexing timed out.")}async generateContent(n,e,t,i){return await this.request(`${O}/models/${n}:generateContent`,{method:"POST",body:JSON.stringify({contents:[{role:"user",parts:[{text:t}]}],tools:[{fileSearch:{fileSearchStoreNames:[e],metadataFilter:i||void 0}}]})})}extractAnswer(n){var r,c,o,u;let e=(r=n.candidates)==null?void 0:r[0],i=((o=(c=e==null?void 0:e.content)==null?void 0:c.parts)!=null?o:[]).map(p=>{var g;return(g=p.text)!=null?g:""}).join(""),s=(u=e==null?void 0:e.groundingMetadata)!=null?u:e==null?void 0:e.grounding_metadata;return{text:i,grounding:s}}async request(n,e){var i;let t=await fetch(n,{...e,headers:{"x-goog-api-key":this.apiKey,"Content-Type":"application/json",...(i=e.headers)!=null?i:{}}});if(!t.ok)throw new Error(await t.text());return t.status===204?{}:t.json()}async delay(n){return new Promise(e=>window.setTimeout(e,n))}};var C=require("obsidian");function J(a){var n,e;return(e=(n=a.stat)==null?void 0:n.mtime)!=null?e:0}async function F(a){var r,c;let n=a.settings.apiKey,e=a.settings.storeName;if(!n){new C.Notice("API key is not set.");return}if(!e){new C.Notice("File Search store name is not set.");return}a.indexState.storeName!==e&&await a.resetIndexStateForStore(e);let t=a.app.vault.getMarkdownFiles(),i=new x(n),s={total:t.length,indexed:0,skipped:0};a.setStatus(`Indexing ${t.length} files...`);for(let o of t){let u=J(o),p=(c=(r=a.indexState.files[o.path])==null?void 0:r.mtime)!=null?c:0;if(u<=p){s.skipped+=1;continue}try{let g=await Y(a,i,e,o,u);g!=null&&g.name&&await i.waitForOperation(g.name),a.indexState.files[o.path]={mtime:u},s.indexed+=1,a.setStatus(`Indexed ${s.indexed}/${s.total} (skipped ${s.skipped})`),await a.saveSettings()}catch(g){console.error(g),new C.Notice(`Failed to index ${o.path}`)}}a.setStatus(`Index complete. Indexed ${s.indexed}, skipped ${s.skipped}.`),new C.Notice(`Index complete. Indexed ${s.indexed}, skipped ${s.skipped}.`)}async function Y(a,n,e,t,i){let s=await a.app.vault.read(t),r=new TextEncoder().encode(s);if(r.byteLength>100*1024*1024)throw new Error(`File too large: ${t.path}`);let c=a.settings.chunkingEnabled?{maxTokensPerChunk:a.settings.maxTokensPerChunk,maxOverlapTokens:a.settings.maxOverlapTokens}:null,o=[{key:"vault",stringValue:a.app.vault.getName()},{key:"path",stringValue:t.path},{key:"mtime",numericValue:i}];return await n.uploadMarkdownToStore(e,{displayName:t.path,bytes:r,chunking:c,metadata:o})}var L=require("obsidian");async function D(a){var i,s;let n=a.settings.apiKey;if(!n){new L.Notice("API key is not set.");return}let e=a.settings.storeDisplayName||"obsidian-vault",t=new x(n);try{a.settings.storeName&&(a.setStatus("Deleting existing File Search store..."),await t.deleteFileSearchStore(a.settings.storeName,!0)),a.setStatus("Creating File Search store...");let r=await t.createFileSearchStore(e);a.settings.storeName=(i=r.name)!=null?i:"",await a.resetIndexStateForStore(a.settings.storeName),await a.saveSettings(),new L.Notice(`Store created: ${(s=r.name)!=null?s:"unknown"}`)}catch(r){console.error(r),new L.Notice("Failed to create store. Check console for details.")}finally{a.setStatus("")}}var E="gemini-file-search-rag-view",M=class extends m.ItemView{constructor(e,t){super(e);this.sourcesMap=new Map;this.plugin=t}getViewType(){return E}getDisplayText(){return"Gemini RAG"}async onOpen(){this.render(),this.cleanupStatus=this.plugin.onStatusChange(e=>{this.statusEl&&(this.statusEl.setText(e),e?this.statusEl.addClass("is-active"):this.statusEl.removeClass("is-active"))})}async onClose(){this.cleanupStatus&&this.cleanupStatus()}render(){let{contentEl:e}=this;e.empty(),e.addClass("gemini-rag-view");let t=e.createEl("div",{cls:"gemini-rag-header"});t.createEl("div",{cls:"gemini-rag-title-wrap"}).createEl("h2",{text:"Gemini RAG"}),this.statusEl=t.createEl("div",{cls:"gemini-rag-status-pill"});let s=e.createEl("div",{cls:"gemini-rag-controls"});s.createEl("div",{cls:"gemini-rag-label"}).setText("Ask about your notes");let c=s.createEl("textarea",{cls:"gemini-rag-input",attr:{rows:"5",placeholder:"Ask something about your notes..."}});this.hintEl=s.createEl("div",{cls:"gemini-rag-hint"}),this.hintEl.setText("\u2318/Ctrl + Enter \u3067\u9001\u4FE1");let o=s.createEl("div",{cls:"gemini-rag-buttons"}),u=o.createEl("button",{cls:"gemini-rag-btn is-primary",text:"Ask"}),p=o.createEl("button",{cls:"gemini-rag-btn",text:"Index vault"}),g=o.createEl("button",{cls:"gemini-rag-btn",text:"Create store"}),h=async()=>{let l=c.value.trim();l&&await this.ask(l)};u.addEventListener("click",h),c.addEventListener("keydown",async l=>{(l.metaKey||l.ctrlKey)&&l.key==="Enter"&&(l.preventDefault(),await h())}),p.addEventListener("click",async()=>{await F(this.plugin)}),g.addEventListener("click",async()=>{await D(this.plugin)});let f=e.createEl("div",{cls:"gemini-rag-section"});f.createEl("h3",{text:"Answer"}),this.answerEl=f.createEl("div",{cls:"gemini-rag-answer"}),this.answerBodyEl=this.answerEl.createEl("div",{cls:"gemini-rag-answer-body"}),this.answerBodyEl.addEventListener("click",l=>{let v=l.target;if(!v)return;let k=v.closest("a");if(!k)return;let w=k.getAttribute("href");if(!w||!w.startsWith("citation:"))return;l.preventDefault();let b=w.replace("citation:",""),T=Number(b);if(!Number.isFinite(T))return;let A=this.sourcesMap.get(T);A&&this.openSource(A,!0)});let S=e.createEl("div",{cls:"gemini-rag-section"});S.createEl("h3",{text:"Sources"}),this.sourcesEl=S.createEl("div",{cls:"gemini-rag-sources"});let d=e.createEl("div",{cls:"gemini-rag-section"});d.createEl("h3",{text:"History"}),this.historyEl=d.createEl("div",{cls:"gemini-rag-history"}),this.renderHistory()}async ask(e){let t=this.plugin.settings.apiKey,i=this.plugin.settings.storeName,s=this.plugin.settings.model;if(!t){new m.Notice("API key is not set.");return}if(!i){new m.Notice("File Search store name is not set.");return}let r=new x(t);try{this.plugin.setStatus("Generating answer..."),this.statusEl&&(this.statusEl.setText("Thinking..."),this.statusEl.addClass("is-active")),this.answerBodyEl&&this.answerBodyEl.setText(""),this.sourcesEl&&this.sourcesEl.setText("");let c=await r.generateContent(s,i,e,this.plugin.settings.metadataFilter||void 0),{text:o,grounding:u}=r.extractAnswer(c),p=this.extractSources(u);this.sourcesMap.clear();for(let h of p)this.sourcesMap.set(h.index,h);let g=this.annotateAnswer(o,u,p);if(this.answerBodyEl&&(this.answerBodyEl.empty(),await m.MarkdownRenderer.renderMarkdown(g,this.answerBodyEl,this.plugin.app.vault.getRoot().path,this)),this.pushHistory(e,g),this.renderHistory(),this.sourcesEl)if(p.length===0)this.sourcesEl.createEl("div",{text:"No sources returned."});else{let h=this.sourcesEl.createEl("ol");for(let f of p)h.createEl("li").createEl("a",{text:`[${f.index}] ${f.label}`,cls:"gemini-rag-source-link"}).addEventListener("click",l=>{l.preventDefault(),this.openSource(f,!0)})}}catch(c){console.error(c),new m.Notice("Failed to generate answer. Check console for details.")}finally{this.plugin.setStatus(""),this.statusEl&&(this.statusEl.setText(""),this.statusEl.removeClass("is-active"))}}pushHistory(e,t){let i={id:`${Date.now()}-${Math.random().toString(16).slice(2)}`,timestamp:Date.now(),question:e,answer:t},s=30;this.plugin.history.unshift(i),this.plugin.history.length>s&&(this.plugin.history=this.plugin.history.slice(0,s)),this.plugin.saveSettings()}renderHistory(){if(this.historyEl){if(this.historyEl.empty(),!this.plugin.history.length){this.historyEl.createEl("div",{text:"No history yet."});return}for(let e of this.plugin.history){let t=this.historyEl.createEl("div",{cls:"gemini-rag-history-item"});t.createEl("div",{cls:"gemini-rag-history-question",text:e.question});let i=t.createEl("div",{cls:"gemini-rag-history-answer"});m.MarkdownRenderer.renderMarkdown(e.answer,i,this.plugin.app.vault.getRoot().path,this)}}}extractSources(e){return e!=null&&e.groundingChunks?e.groundingChunks.map((t,i)=>{var h,f,S,d,l;let s=(h=t.retrievedContext)!=null?h:t.retrieved_context,r=(S=(f=s==null?void 0:s.title)!=null?f:s==null?void 0:s.displayName)!=null?S:s==null?void 0:s.display_name,c=(d=s==null?void 0:s.uri)!=null?d:s==null?void 0:s.uri,o=(l=s==null?void 0:s.text)!=null?l:s==null?void 0:s.text,u=r||c||`Chunk ${i+1}`,p=o?o.slice(0,200):void 0,g=this.resolveVaultPath(r);return{label:u,detail:p,path:g,uri:c,index:i+1,text:o}}):[]}annotateAnswer(e,t,i){var u,p,g,h,f,S;if(!t)return e;let s=(p=(u=t.groundingSupports)!=null?u:t.grounding_supports)!=null?p:[];if(s.length===0)return e;let r=new Map;for(let d of s){let l=(g=d.segment)!=null?g:d.segment,v=(h=l==null?void 0:l.endIndex)!=null?h:l==null?void 0:l.end_index,k=(f=d.groundingChunkIndices)!=null?f:d.grounding_chunk_indices;if(typeof v!="number"||!Array.isArray(k))continue;let w=k.map(P=>{var R;return(R=i[P])==null?void 0:R.index}).filter(P=>typeof P=="number");if(w.length===0)continue;let b=Array.from(new Set(w)).sort((P,R)=>P-R),T=this.findSentenceEnd(e,v),A=(S=r.get(T))!=null?S:[];r.set(T,A.concat(b))}if(r.size===0)return e;let c=[];for(let[d,l]of r.entries()){let k=Array.from(new Set(l)).sort((w,b)=>w-b).map(w=>`[${w}](citation:${w})`).join(" ");c.push({pos:d,marker:` ${k}`})}c.sort((d,l)=>l.pos-d.pos);let o=e;for(let d of c)d.pos>=0&&d.pos<=o.length?o=o.slice(0,d.pos)+d.marker+o.slice(d.pos):o+=d.marker;return o}findSentenceEnd(e,t){if(t>=e.length)return e.length;let i=[".","!","?","\u3002","\uFF01","\uFF1F",`
`];for(let s=Math.max(0,t);s<e.length;s+=1){let r=e.charAt(s);if(i.includes(r))return s+1}return e.length}resolveVaultPath(e){if(!e)return;if(this.app.vault.getAbstractFileByPath(e))return e}async openSource(e,t){if(e.path){let i=this.app.vault.getAbstractFileByPath(e.path);if(i instanceof m.TFile){let s=this.app.workspace.getLeaf(!0);if(await s.openFile(i),t&&e.text){let r=s.view;r instanceof m.MarkdownView&&r.editor&&await this.highlightSnippet(r.editor,e.text)}return}}if(e.uri){if(e.uri.startsWith("obsidian://")){window.open(e.uri,"_blank");return}window.open(e.uri,"_blank")}}async highlightSnippet(e,t){let i=e.getValue(),s=t.trim();if(!s)return;let r=i.indexOf(s);if(r===-1)return;let c=e.offsetToPos(r),o=e.offsetToPos(r+s.length);e.setSelection(c,o),e.scrollIntoView({from:c,to:o},!0)}};async function G(a){let{workspace:n}=a.app,e=n.getLeavesOfType(E)[0];if(!e){let t=n.getRightLeaf(!1);e=t!=null?t:void 0,e||(e=n.getLeaf(!1)),await e.setViewState({type:E,active:!0})}await n.revealLeaf(e)}function _(a){a.addCommand({id:"open-gemini-rag-panel",name:"Open Gemini RAG panel",callback:()=>G(a)}),a.addCommand({id:"index-vault-to-file-search",name:"Index vault to File Search",callback:()=>F(a)}),a.addCommand({id:"create-file-search-store",name:"Create File Search store",callback:()=>D(a)})}var N={version:1,files:{}};var $=class extends B.Plugin{constructor(){super(...arguments);this.statusListeners=new Set}async onload(){await this.loadSettings(),this.registerView(E,e=>new M(e,this)),this.addSettingTab(new I(this.app,this)),_(this),this.app.workspace.onLayoutReady(()=>{G(this)})}onunload(){this.app.workspace.detachLeavesOfType(E)}setStatus(e){for(let t of this.statusListeners)t(e)}onStatusChange(e){return this.statusListeners.add(e),()=>{this.statusListeners.delete(e)}}async loadSettings(){var t,i;let e=await this.loadData();if(e&&"settings"in e){let s=e;this.settings=Object.assign({},V,(t=s.settings)!=null?t:{}),this.indexState=Object.assign({},N,(i=s.indexState)!=null?i:{}),this.history=Array.isArray(s.history)?s.history:[]}else{let s=e!=null?e:{};this.settings=Object.assign({},V,s),this.indexState=Object.assign({},N),this.history=[]}}async saveSettings(){let e={settings:this.settings,indexState:this.indexState,history:this.history};await this.saveData(e)}async resetIndexState(){this.indexState=Object.assign({},N),await this.saveSettings()}async resetIndexStateForStore(e){this.indexState=Object.assign({},N,{storeName:e}),await this.saveSettings()}};
