/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

var D=Object.defineProperty;var j=Object.getOwnPropertyDescriptor;var X=Object.getOwnPropertyNames;var z=Object.prototype.hasOwnProperty;var Y=(n,s)=>{for(var t in s)D(n,t,{get:s[t],enumerable:!0})},J=(n,s,t,i)=>{if(s&&typeof s=="object"||typeof s=="function")for(let e of X(s))!z.call(n,e)&&e!==t&&D(n,e,{get:()=>s[e],enumerable:!(i=j(s,e))||i.enumerable});return n};var Q=n=>J(D({},"__esModule",{value:!0}),n);var it={};Y(it,{default:()=>$});module.exports=Q(it);var W=require("obsidian");var v=require("obsidian"),M={apiKey:"",model:"gemini-2.5-flash",storeName:"",storeDisplayName:"obsidian-vault"},N=class extends v.PluginSettingTab{constructor(s,t){super(s,t),this.plugin=t}display(){let{containerEl:s}=this;s.empty(),new v.Setting(s).setName("API key").setDesc("Gemini API key. This plugin sends note contents to google for indexing and answers.").addText(t=>{t.inputEl.type="password",t.setPlaceholder("API key").setValue(this.plugin.settings.apiKey).onChange(async i=>{this.plugin.settings.apiKey=i.trim(),await this.plugin.saveSettings()})}),new v.Setting(s).setName("Model").setDesc("Model used for answering queries.").addText(t=>t.setValue(this.plugin.settings.model).onChange(async i=>{this.plugin.settings.model=i.trim(),await this.plugin.saveSettings()})),new v.Setting(s).setName("File search store name").setDesc("Full resource name").addText(t=>t.setValue(this.plugin.settings.storeName).onChange(async i=>{this.plugin.settings.storeName=i.trim(),await this.plugin.saveSettings()})),new v.Setting(s).setName("Store display name").setDesc("Used when creating a new store from the command palette.").addText(t=>t.setValue(this.plugin.settings.storeDisplayName).onChange(async i=>{this.plugin.settings.storeDisplayName=i.trim(),await this.plugin.saveSettings()})),new v.Setting(s).setName("Reset local index state").setDesc("Clears local index tracking. This does not delete remote documents.").addButton(t=>t.setButtonText("Reset").onClick(async()=>{await this.plugin.resetIndexState()}))}};var b=require("obsidian");var G=require("obsidian"),I="https://generativelanguage.googleapis.com/v1beta",Z="https://generativelanguage.googleapis.com/upload/v1beta",E=class{constructor(s){this.apiKey=s}async createFileSearchStore(s){return await this.request(`${I}/fileSearchStores`,{method:"POST",body:JSON.stringify({displayName:s})})}async deleteFileSearchStore(s,t=!0){let i=new URL(`${I}/${s}`);t&&i.searchParams.set("force","true"),await this.request(i.toString(),{method:"DELETE"})}async uploadMarkdownToStore(s,t){let i=await fetch(`${Z}/${s}:uploadToFileSearchStore`,{method:"POST",headers:{"x-goog-api-key":this.apiKey,"X-Goog-Upload-Protocol":"resumable","X-Goog-Upload-Command":"start","X-Goog-Upload-Header-Content-Length":String(t.bytes.byteLength),"X-Goog-Upload-Header-Content-Type":"text/markdown","Content-Type":"application/json"},body:JSON.stringify({displayName:t.displayName,mimeType:"text/markdown",customMetadata:t.metadata})});if(!i.ok)throw new Error(`Upload start failed: ${await i.text()}`);let e=i.headers.get("x-goog-upload-url");if(!e)throw new Error("Upload URL missing from response.");let a=await fetch(e,{method:"POST",headers:{"X-Goog-Upload-Command":"upload, finalize","X-Goog-Upload-Offset":"0"},body:new Blob([t.bytes.slice().buffer],{type:"text/markdown"})});if(!a.ok)throw new Error(`Upload finalize failed: ${await a.text()}`);return await a.json()}async waitForOperation(s,t=12e4){var e;let i=Date.now();for(;Date.now()-i<t;){let a=await this.request(`${I}/${s}`,{method:"GET"});if(a.done){if((e=a.error)!=null&&e.message)throw new Error(a.error.message);return}await this.delay(1e3)}throw new Error("Indexing timed out.")}async generateContent(s,t,i,e){return await this.request(`${I}/models/${s}:generateContent`,{method:"POST",body:JSON.stringify({contents:[{role:"user",parts:[{text:i}]}],tools:[{fileSearch:{fileSearchStoreNames:[t]}}],generationConfig:e?{thinkingConfig:{includeThoughts:!0}}:void 0})})}extractAnswer(s){var p,m,u,w,d;let t=(p=s.candidates)==null?void 0:p[0],i=(u=(m=t==null?void 0:t.content)==null?void 0:m.parts)!=null?u:[],e=[],a=[];for(let g of i){let o=(w=g.text)!=null?w:"";o&&(g.thought?e.push(o):a.push(o))}let r=a.join(""),l=e.join(""),c=(d=t==null?void 0:t.groundingMetadata)!=null?d:t==null?void 0:t.grounding_metadata;return{text:r,grounding:c,thoughtSummary:l||void 0}}async request(s,t){let i={url:s,method:t.method,headers:{"x-goog-api-key":this.apiKey,"Content-Type":"application/json"},body:t.body,throw:!1},e=await(0,G.requestUrl)(i);if(e.status>=400)throw new Error(e.text);return e.status===204?{}:e.json}async delay(s){return new Promise(t=>window.setTimeout(t,s))}};var R=require("obsidian");function tt(n){var s,t;return(t=(s=n.stat)==null?void 0:s.mtime)!=null?t:0}async function O(n){var r,l;let s=n.settings.apiKey,t=n.settings.storeName;if(!s){new R.Notice("API key is not set.");return}if(!t){new R.Notice("File search store name is not set.");return}n.indexState.storeName!==t&&await n.resetIndexStateForStore(t);let i=n.app.vault.getMarkdownFiles(),e=new E(s),a={total:i.length,indexed:0,skipped:0};n.setStatus(`Indexing ${i.length} files...`);for(let c of i){let p=tt(c),m=(l=(r=n.indexState.files[c.path])==null?void 0:r.mtime)!=null?l:0;if(p<=m){a.skipped+=1;continue}try{let u=await et(n,e,t,c,p);u!=null&&u.name&&await e.waitForOperation(u.name),n.indexState.files[c.path]={mtime:p},a.indexed+=1,n.setStatus(`Indexed ${a.indexed}/${a.total} (skipped ${a.skipped})`),await n.saveSettings()}catch(u){console.error(u),new R.Notice(`Failed to index ${c.path}`)}}n.setStatus(`Index complete. Indexed ${a.indexed}, skipped ${a.skipped}.`),new R.Notice(`Index complete. Indexed ${a.indexed}, skipped ${a.skipped}.`)}async function et(n,s,t,i,e){let a=await n.app.vault.read(i),r=new TextEncoder().encode(a);if(r.byteLength>100*1024*1024)throw new Error(`File too large: ${i.path}`);let l=[{key:"vault",stringValue:n.app.vault.getName()},{key:"path",stringValue:i.path},{key:"mtime",numericValue:e}];return await s.uploadMarkdownToStore(t,{displayName:i.path,bytes:r,metadata:l})}var L=require("obsidian");async function F(n){var e,a;let s=n.settings.apiKey;if(!s){new L.Notice("API key is not set.");return}let t=n.settings.storeDisplayName||"obsidian-vault",i=new E(s);try{n.settings.storeName&&(n.setStatus("Deleting existing File Search store..."),await i.deleteFileSearchStore(n.settings.storeName,!0)),n.setStatus("Creating File Search store...");let r=await i.createFileSearchStore(t);n.settings.storeName=(e=r.name)!=null?e:"",await n.resetIndexStateForStore(n.settings.storeName),await n.saveSettings(),new L.Notice(`Store created: ${(a=r.name)!=null?a:"unknown"}`)}catch(r){console.error(r),new L.Notice("Failed to create store. Check console for details.")}finally{n.setStatus("")}}function U(n,s){return n!=null&&n.groundingChunks?n.groundingChunks.map((t,i)=>{var u,w,d,g,o;let e=(u=t.retrievedContext)!=null?u:t.retrieved_context,a=(d=(w=e==null?void 0:e.title)!=null?w:e==null?void 0:e.displayName)!=null?d:e==null?void 0:e.display_name,r=(g=e==null?void 0:e.uri)!=null?g:e==null?void 0:e.uri,l=(o=e==null?void 0:e.text)!=null?o:e==null?void 0:e.text,c=a||r||`Chunk ${i+1}`,p=l?l.slice(0,200):void 0,m=s(a);return{label:c,detail:p,path:m,uri:r,index:i+1,text:l}}):[]}function _(n,s,t){var l,c,p,m,u,w;if(!s)return n;let i=(c=(l=s.groundingSupports)!=null?l:s.grounding_supports)!=null?c:[];if(i.length===0)return n;let e=new Map;for(let d of i){let g=(p=d.segment)!=null?p:d.segment,o=(m=g==null?void 0:g.endIndex)!=null?m:g==null?void 0:g.end_index,y=(u=d.groundingChunkIndices)!=null?u:d.grounding_chunk_indices;if(typeof o!="number"||!Array.isArray(y))continue;let h=y.map(S=>{var x;return(x=t[S])==null?void 0:x.index}).filter(S=>typeof S=="number");if(h.length===0)continue;let f=Array.from(new Set(h)).sort((S,x)=>S-x),P=(w=e.get(o))!=null?w:[];e.set(o,P.concat(f))}if(e.size===0)return n;let a=[];for(let[d,g]of e.entries()){let y=Array.from(new Set(g)).sort((h,f)=>h-f).map(h=>`[${h}](citation:${h})`).join(" ");a.push({pos:d,marker:y})}a.sort((d,g)=>g.pos-d.pos);let r=n;for(let d of a)d.pos>=0&&d.pos<=r.length?r=r.slice(0,d.pos)+d.marker+r.slice(d.pos):r+=d.marker;return r}var V=require("obsidian");function B(n,s){if(!s)return;if(n.vault.getAbstractFileByPath(s))return s;let i=s.replace(/\.md$/i,""),e=n.vault.getFiles();for(let a of e)if(a.basename===i)return a.path}async function H(n,s){if(s.path){let t=n.vault.getAbstractFileByPath(s.path);if(t instanceof V.TFile){await n.workspace.getLeaf(!0).openFile(t);return}}s.uri&&window.open(s.uri,"_blank")}var k="gemini-file-search-rag-view",C=class extends b.ItemView{constructor(t,i){super(t);this.sourcesMap=new Map;this.plugin=i}getViewType(){return k}getDisplayText(){return"Obsidian agent"}async onOpen(){this.render(),this.cleanupStatus=this.plugin.onStatusChange(t=>{this.statusEl&&(this.statusEl.setText(t),t?this.statusEl.addClass("is-active"):this.statusEl.removeClass("is-active"))})}async onClose(){this.cleanupStatus&&this.cleanupStatus()}render(){let{contentEl:t}=this;t.empty(),t.addClass("gemini-rag-view");let i=t.createEl("div",{cls:"gemini-rag-header"});i.createEl("div",{cls:"gemini-rag-title-wrap"}).createEl("h2",{text:"Obsidian agent"});let a=i.createEl("div",{cls:"gemini-rag-header-actions"});this.statusEl=a.createEl("div",{cls:"gemini-rag-status-pill"});let r=a.createEl("button",{cls:"gemini-rag-icon-btn",attr:{"aria-label":"New chat",title:"New chat"}});(0,b.setIcon)(r,"plus");let l=t.createEl("div",{cls:"gemini-rag-main"});this.chatEl=l.createEl("div",{cls:"gemini-rag-chat"}),this.chatEl.addEventListener("click",o=>{let y=o.target;if(!y)return;let h=y.closest("a");if(!h)return;let f=h.getAttribute("href");if(!f||!f.startsWith("citation:"))return;o.preventDefault();let P=f.replace("citation:",""),S=Number(P);if(!Number.isFinite(S))return;let x=this.sourcesMap.get(S);x&&H(this.app,x)}),this.chatEl.addEventListener("mouseover",o=>{let y=o.target;if(!y)return;let h=y.closest("a");if(!h)return;let f=h.getAttribute("href");if(!f||!f.startsWith("citation:"))return;let P=f.replace("citation:",""),S=Number(P);if(!Number.isFinite(S))return;let x=this.sourcesMap.get(S);x&&this.showTooltip(h,x)}),this.chatEl.addEventListener("mouseout",o=>{let y=o.target;if(!y)return;let h=y.closest("a");if(!h)return;let f=h.getAttribute("href");!f||!f.startsWith("citation:")||this.hideTooltip()}),this.renderHistory();let c=t.createEl("div",{cls:"gemini-rag-controls"}),p=c.createEl("textarea",{cls:"gemini-rag-input",attr:{rows:"5",placeholder:"Ask something about your notes..."}});this.hintEl=c.createEl("div",{cls:"gemini-rag-hint"}),this.hintEl.setText("\u2318/Ctrl + Enter \u3067\u9001\u4FE1");let m=c.createEl("div",{cls:"gemini-rag-buttons"}),u=m.createEl("button",{cls:"gemini-rag-btn is-primary",text:"Ask"}),w=m.createEl("button",{cls:"gemini-rag-btn",text:"Index vault"}),d=m.createEl("button",{cls:"gemini-rag-btn",text:"Create store"}),g=async()=>{let o=p.value.trim();o&&await this.ask(o)};r.addEventListener("click",()=>{this.clearChat()}),u.addEventListener("click",()=>{g()}),p.addEventListener("keydown",o=>{(o.metaKey||o.ctrlKey)&&o.key==="Enter"&&(o.preventDefault(),g())}),w.addEventListener("click",()=>{O(this.plugin)}),d.addEventListener("click",()=>{F(this.plugin)})}async clearChat(){this.plugin.history=[],await this.plugin.saveSettings(),this.sourcesMap.clear(),this.renderHistory()}async ask(t){let i=this.plugin.settings.apiKey,e=this.plugin.settings.storeName,a=this.plugin.settings.model;if(!i){new b.Notice("API key is not set.");return}if(!e){new b.Notice("File search store name is not set.");return}let r=new E(i);try{this.plugin.setStatus("Generating answer..."),this.statusEl&&(this.statusEl.setText("Thinking..."),this.statusEl.addClass("is-active"));let l=await r.generateContent(a,e,t,!0),{text:c,grounding:p,thoughtSummary:m}=r.extractAnswer(l),u=U(p,g=>B(this.app,g));this.sourcesMap.clear();for(let g of u)this.sourcesMap.set(g.index,g);let w=_(c,p,u),d=this.formatOutput(w,m);this.pushHistory(t,d),this.renderHistory()}catch(l){console.error(l),new b.Notice("Failed to generate answer. Check console for details.")}finally{this.plugin.setStatus(""),this.statusEl&&(this.statusEl.setText(""),this.statusEl.removeClass("is-active"))}}formatOutput(t,i){let e="\u63A8\u8AD6\u306E\u8981\u7D04",a=i==null?void 0:i.trim();return a?t.trim()?`**${e}**

${a}

${t}`:`**${e}**

${a}`:t}pushHistory(t,i){let e={id:`${Date.now()}-${Math.random().toString(16).slice(2)}`,timestamp:Date.now(),question:t,answer:i},a=50;this.plugin.history.push(e),this.plugin.history.length>a&&(this.plugin.history=this.plugin.history.slice(-a)),this.plugin.saveSettings()}renderHistory(){if(this.chatEl){if(this.chatEl.empty(),!this.plugin.history.length){this.chatEl.createEl("div",{cls:"gemini-rag-chat-empty",text:"No messages yet."});return}for(let t of this.plugin.history){this.chatEl.createEl("div",{cls:"gemini-rag-chat-bubble user"}).createEl("div",{cls:"gemini-rag-chat-text",text:t.question});let a=this.chatEl.createEl("div",{cls:"gemini-rag-chat-bubble assistant"}).createEl("div",{cls:"gemini-rag-chat-text"});b.MarkdownRenderer.render(this.plugin.app,t.answer,a,this.plugin.app.vault.getRoot().path,this)}}}showTooltip(t,i){this.hideTooltip();let e=document.createElement("div");e.className="gemini-rag-tooltip";let a=e.createEl("div",{cls:"gemini-rag-tooltip-header"});if(a.createEl("span",{cls:"gemini-rag-tooltip-icon",text:"\u{1F4C4}"}),a.createEl("span",{cls:"gemini-rag-tooltip-title",text:i.label}),i.text){let m=i.text.slice(0,150).trim(),u=m.length<i.text.length?m+"...":m;e.createEl("div",{cls:"gemini-rag-tooltip-body",text:u})}else i.detail&&e.createEl("div",{cls:"gemini-rag-tooltip-body",text:i.detail});document.body.appendChild(e),this.tooltipEl=e;let r=t.getBoundingClientRect(),l=e.getBoundingClientRect(),c=r.left+r.width/2-l.width/2,p=r.bottom+8;c<8&&(c=8),c+l.width>window.innerWidth-8&&(c=window.innerWidth-l.width-8),p+l.height>window.innerHeight-8&&(p=r.top-l.height-8),e.style.left=`${c}px`,e.style.top=`${p}px`}hideTooltip(){this.tooltipEl&&(this.tooltipEl.remove(),this.tooltipEl=void 0)}};async function T(n){let{workspace:s}=n.app,t=s.getLeavesOfType(k)[0];if(!t){let i=s.getRightLeaf(!1);t=i!=null?i:void 0,t||(t=s.getLeaf(!1)),await t.setViewState({type:k,active:!0})}await s.revealLeaf(t)}async function K(n){await T(n);let s=n.app.workspace.getLeavesOfType(k);if(s.length===0){n.history=[],await n.saveSettings();return}for(let t of s){let i=t.view;i instanceof C&&await i.clearChat()}}function q(n){n.addCommand({id:"open-gemini-rag-panel",name:"Open panel",callback:()=>T(n)}),n.addCommand({id:"new-chat",name:"New chat",callback:()=>K(n)}),n.addCommand({id:"index-vault-to-file-search",name:"Index vault to file search",callback:()=>O(n)}),n.addCommand({id:"create-file-search-store",name:"Create file search store",callback:()=>F(n)})}var A={version:1,files:{}};var $=class extends W.Plugin{constructor(){super(...arguments);this.statusListeners=new Set}async onload(){await this.loadSettings(),this.registerView(k,t=>new C(t,this)),this.addSettingTab(new N(this.app,this)),q(this),this.app.workspace.onLayoutReady(()=>{T(this)})}setStatus(t){for(let i of this.statusListeners)i(t)}onStatusChange(t){return this.statusListeners.add(t),()=>{this.statusListeners.delete(t)}}async loadSettings(){var i,e;let t=await this.loadData();if(t&&"settings"in t)this.settings=Object.assign({},M,(i=t.settings)!=null?i:{}),this.indexState=Object.assign({},A,(e=t.indexState)!=null?e:{}),this.history=Array.isArray(t.history)?t.history:[];else{let a=t!=null?t:{};this.settings=Object.assign({},M,a),this.indexState=Object.assign({},A),this.history=[]}}async saveSettings(){let t={settings:this.settings,indexState:this.indexState,history:this.history};await this.saveData(t)}async resetIndexState(){this.indexState=Object.assign({},A),await this.saveSettings()}async resetIndexStateForStore(t){this.indexState=Object.assign({},A,{storeName:t}),await this.saveSettings()}};
