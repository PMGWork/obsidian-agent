/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

var $=Object.defineProperty;var j=Object.getOwnPropertyDescriptor;var q=Object.getOwnPropertyNames;var H=Object.prototype.hasOwnProperty;var B=(a,i)=>{for(var e in i)$(a,e,{get:i[e],enumerable:!0})},W=(a,i,e,t)=>{if(i&&typeof i=="object"||typeof i=="function")for(let s of q(i))!H.call(a,s)&&s!==e&&$(a,s,{get:()=>i[s],enumerable:!(t=j(i,s))||t.enumerable});return a};var X=a=>W($({},"__esModule",{value:!0}),a);var Q={};B(Q,{default:()=>M});module.exports=X(Q);var G=require("obsidian");var y=require("obsidian"),U={apiKey:"",model:"gemini-2.5-flash",storeName:"",storeDisplayName:"obsidian-vault",metadataFilter:"",chunkingEnabled:!0,maxTokensPerChunk:200,maxOverlapTokens:20},N=class extends y.PluginSettingTab{constructor(i,e){super(i,e),this.plugin=e}display(){let{containerEl:i}=this;i.empty(),i.createEl("h2",{text:"Obsidian Agent settings"}),new y.Setting(i).setName("API key").setDesc("Gemini API key. This plugin sends note contents to Google for indexing and answers.").addText(e=>{e.inputEl.type="password",e.setPlaceholder("AI Studio API key").setValue(this.plugin.settings.apiKey).onChange(async t=>{this.plugin.settings.apiKey=t.trim(),await this.plugin.saveSettings()})}),new y.Setting(i).setName("Model").setDesc("Model used for answering queries.").addText(e=>e.setPlaceholder("gemini-2.5-flash").setValue(this.plugin.settings.model).onChange(async t=>{this.plugin.settings.model=t.trim(),await this.plugin.saveSettings()})),new y.Setting(i).setName("File Search store name").setDesc("Full resource name, for example: fileSearchStores/1234567890").addText(e=>e.setPlaceholder("fileSearchStores/...").setValue(this.plugin.settings.storeName).onChange(async t=>{this.plugin.settings.storeName=t.trim(),await this.plugin.saveSettings()})),new y.Setting(i).setName("Store display name").setDesc("Used when creating a new store from the command palette.").addText(e=>e.setPlaceholder("obsidian-vault").setValue(this.plugin.settings.storeDisplayName).onChange(async t=>{this.plugin.settings.storeDisplayName=t.trim(),await this.plugin.saveSettings()})),new y.Setting(i).setName("Metadata filter").setDesc('Optional: filter sources by metadata (AIP-160 syntax). Example: author="Alice"').addText(e=>e.setPlaceholder('author="Alice"').setValue(this.plugin.settings.metadataFilter).onChange(async t=>{this.plugin.settings.metadataFilter=t.trim(),await this.plugin.saveSettings()})),new y.Setting(i).setName("Chunking config").setDesc("Use custom chunk sizes for File Search indexing (white-space chunking).").addToggle(e=>e.setValue(this.plugin.settings.chunkingEnabled).onChange(async t=>{this.plugin.settings.chunkingEnabled=t,await this.plugin.saveSettings()})),new y.Setting(i).setName("Max tokens per chunk").setDesc("Used when chunking is enabled. Default is 200.").addText(e=>e.setPlaceholder("200").setValue(String(this.plugin.settings.maxTokensPerChunk)).onChange(async t=>{let s=Number.parseInt(t,10);!Number.isNaN(s)&&s>0&&(this.plugin.settings.maxTokensPerChunk=s,await this.plugin.saveSettings())})),new y.Setting(i).setName("Max overlap tokens").setDesc("Used when chunking is enabled. Default is 20.").addText(e=>e.setPlaceholder("20").setValue(String(this.plugin.settings.maxOverlapTokens)).onChange(async t=>{let s=Number.parseInt(t,10);!Number.isNaN(s)&&s>=0&&(this.plugin.settings.maxOverlapTokens=s,await this.plugin.saveSettings())})),new y.Setting(i).setName("Reset local index state").setDesc("Clears local index tracking. This does not delete remote documents.").addButton(e=>e.setButtonText("Reset").onClick(async()=>{await this.plugin.resetIndexState()}))}};var w=require("obsidian");var O="https://generativelanguage.googleapis.com/v1beta",z="https://generativelanguage.googleapis.com/upload/v1beta",x=class{constructor(i){this.apiKey=i}async createFileSearchStore(i){return await this.request(`${O}/fileSearchStores`,{method:"POST",body:JSON.stringify({displayName:i})})}async deleteFileSearchStore(i,e=!0){let t=new URL(`${O}/${i}`);e&&t.searchParams.set("force","true"),await this.request(t.toString(),{method:"DELETE"})}async uploadMarkdownToStore(i,e){let t=await fetch(`${z}/${i}:uploadToFileSearchStore`,{method:"POST",headers:{"x-goog-api-key":this.apiKey,"X-Goog-Upload-Protocol":"resumable","X-Goog-Upload-Command":"start","X-Goog-Upload-Header-Content-Length":String(e.bytes.byteLength),"X-Goog-Upload-Header-Content-Type":"text/markdown","Content-Type":"application/json"},body:JSON.stringify({displayName:e.displayName,mimeType:"text/markdown",chunkingConfig:e.chunking?{whiteSpaceConfig:{maxTokensPerChunk:e.chunking.maxTokensPerChunk,maxOverlapTokens:e.chunking.maxOverlapTokens}}:void 0,customMetadata:e.metadata})});if(!t.ok)throw new Error(`Upload start failed: ${await t.text()}`);let s=t.headers.get("x-goog-upload-url");if(!s)throw new Error("Upload URL missing from response.");let n=await fetch(s,{method:"POST",headers:{"X-Goog-Upload-Command":"upload, finalize","X-Goog-Upload-Offset":"0"},body:e.bytes});if(!n.ok)throw new Error(`Upload finalize failed: ${await n.text()}`);return await n.json()}async waitForOperation(i,e=12e4){var s;let t=Date.now();for(;Date.now()-t<e;){let n=await this.request(`${O}/${i}`,{method:"GET"});if(n.done){if((s=n.error)!=null&&s.message)throw new Error(n.error.message);return}await this.delay(1e3)}throw new Error("Indexing timed out.")}async generateContent(i,e,t,s){return await this.request(`${O}/models/${i}:generateContent`,{method:"POST",body:JSON.stringify({contents:[{role:"user",parts:[{text:t}]}],tools:[{fileSearch:{fileSearchStoreNames:[e],metadataFilter:s||void 0}}]})})}extractAnswer(i){var r,l,o,d;let e=(r=i.candidates)==null?void 0:r[0],s=((o=(l=e==null?void 0:e.content)==null?void 0:l.parts)!=null?o:[]).map(h=>{var g;return(g=h.text)!=null?g:""}).join(""),n=(d=e==null?void 0:e.groundingMetadata)!=null?d:e==null?void 0:e.grounding_metadata;return{text:s,grounding:n}}async request(i,e){var s;let t=await fetch(i,{...e,headers:{"x-goog-api-key":this.apiKey,"Content-Type":"application/json",...(s=e.headers)!=null?s:{}}});if(!t.ok)throw new Error(await t.text());return t.status===204?{}:t.json()}async delay(i){return new Promise(e=>window.setTimeout(e,i))}};var P=require("obsidian");function Y(a){var i,e;return(e=(i=a.stat)==null?void 0:i.mtime)!=null?e:0}async function R(a){var r,l;let i=a.settings.apiKey,e=a.settings.storeName;if(!i){new P.Notice("API key is not set.");return}if(!e){new P.Notice("File Search store name is not set.");return}a.indexState.storeName!==e&&await a.resetIndexStateForStore(e);let t=a.app.vault.getMarkdownFiles(),s=new x(i),n={total:t.length,indexed:0,skipped:0};a.setStatus(`Indexing ${t.length} files...`);for(let o of t){let d=Y(o),h=(l=(r=a.indexState.files[o.path])==null?void 0:r.mtime)!=null?l:0;if(d<=h){n.skipped+=1;continue}try{let g=await J(a,s,e,o,d);g!=null&&g.name&&await s.waitForOperation(g.name),a.indexState.files[o.path]={mtime:d},n.indexed+=1,a.setStatus(`Indexed ${n.indexed}/${n.total} (skipped ${n.skipped})`),await a.saveSettings()}catch(g){console.error(g),new P.Notice(`Failed to index ${o.path}`)}}a.setStatus(`Index complete. Indexed ${n.indexed}, skipped ${n.skipped}.`),new P.Notice(`Index complete. Indexed ${n.indexed}, skipped ${n.skipped}.`)}async function J(a,i,e,t,s){let n=await a.app.vault.read(t),r=new TextEncoder().encode(n);if(r.byteLength>100*1024*1024)throw new Error(`File too large: ${t.path}`);let l=a.settings.chunkingEnabled?{maxTokensPerChunk:a.settings.maxTokensPerChunk,maxOverlapTokens:a.settings.maxOverlapTokens}:null,o=[{key:"vault",stringValue:a.app.vault.getName()},{key:"path",stringValue:t.path},{key:"mtime",numericValue:s}];return await i.uploadMarkdownToStore(e,{displayName:t.path,bytes:r,chunking:l,metadata:o})}var I=require("obsidian");async function F(a){var s,n;let i=a.settings.apiKey;if(!i){new I.Notice("API key is not set.");return}let e=a.settings.storeDisplayName||"obsidian-vault",t=new x(i);try{a.settings.storeName&&(a.setStatus("Deleting existing File Search store..."),await t.deleteFileSearchStore(a.settings.storeName,!0)),a.setStatus("Creating File Search store...");let r=await t.createFileSearchStore(e);a.settings.storeName=(s=r.name)!=null?s:"",await a.resetIndexStateForStore(a.settings.storeName),await a.saveSettings(),new I.Notice(`Store created: ${(n=r.name)!=null?n:"unknown"}`)}catch(r){console.error(r),new I.Notice("Failed to create store. Check console for details.")}finally{a.setStatus("")}}var b="gemini-file-search-rag-view",D=class extends w.ItemView{constructor(e,t){super(e);this.sourcesMap=new Map;this.plugin=t}getViewType(){return b}getDisplayText(){return"Obsidian Agent"}async onOpen(){this.render(),this.cleanupStatus=this.plugin.onStatusChange(e=>{this.statusEl&&(this.statusEl.setText(e),e?this.statusEl.addClass("is-active"):this.statusEl.removeClass("is-active"))})}async onClose(){this.cleanupStatus&&this.cleanupStatus()}render(){let{contentEl:e}=this;e.empty(),e.addClass("gemini-rag-view");let t=e.createEl("div",{cls:"gemini-rag-header"});t.createEl("div",{cls:"gemini-rag-title-wrap"}).createEl("h2",{text:"Obsidian Agent"}),this.statusEl=t.createEl("div",{cls:"gemini-rag-status-pill"}),this.chatEl=e.createEl("div",{cls:"gemini-rag-chat"}),this.chatEl.addEventListener("click",p=>{let c=p.target;if(!c)return;let u=c.closest("a");if(!u)return;let k=u.getAttribute("href");if(!k||!k.startsWith("citation:"))return;p.preventDefault();let v=k.replace("citation:",""),S=Number(v);if(!Number.isFinite(S))return;let E=this.sourcesMap.get(S);E&&this.openSource(E,!0)}),this.renderHistory();let n=e.createEl("div",{cls:"gemini-rag-controls"});n.createEl("div",{cls:"gemini-rag-label"}).setText("Ask about your notes");let l=n.createEl("textarea",{cls:"gemini-rag-input",attr:{rows:"5",placeholder:"Ask something about your notes..."}});this.hintEl=n.createEl("div",{cls:"gemini-rag-hint"}),this.hintEl.setText("\u2318/Ctrl + Enter \u3067\u9001\u4FE1");let o=n.createEl("div",{cls:"gemini-rag-buttons"}),d=o.createEl("button",{cls:"gemini-rag-btn is-primary",text:"Ask"}),h=o.createEl("button",{cls:"gemini-rag-btn",text:"Index vault"}),g=o.createEl("button",{cls:"gemini-rag-btn",text:"Create store"}),m=async()=>{let p=l.value.trim();p&&await this.ask(p)};d.addEventListener("click",m),l.addEventListener("keydown",async p=>{(p.metaKey||p.ctrlKey)&&p.key==="Enter"&&(p.preventDefault(),await m())}),h.addEventListener("click",async()=>{await R(this.plugin)}),g.addEventListener("click",async()=>{await F(this.plugin)});let f=e.createEl("div",{cls:"gemini-rag-section"});f.createEl("h3",{text:"Sources"}),this.sourcesEl=f.createEl("div",{cls:"gemini-rag-sources"})}async ask(e){let t=this.plugin.settings.apiKey,s=this.plugin.settings.storeName,n=this.plugin.settings.model;if(!t){new w.Notice("API key is not set.");return}if(!s){new w.Notice("File Search store name is not set.");return}let r=new x(t);try{this.plugin.setStatus("Generating answer..."),this.statusEl&&(this.statusEl.setText("Thinking..."),this.statusEl.addClass("is-active")),this.sourcesEl&&this.sourcesEl.setText("");let l=await r.generateContent(n,s,e,this.plugin.settings.metadataFilter||void 0),{text:o,grounding:d}=r.extractAnswer(l),h=this.extractSources(d);this.sourcesMap.clear();for(let m of h)this.sourcesMap.set(m.index,m);let g=this.annotateAnswer(o,d,h);if(this.pushHistory(e,g),this.renderHistory(),this.sourcesEl)if(h.length===0)this.sourcesEl.createEl("div",{text:"No sources returned."});else{let m=this.sourcesEl.createEl("ol");for(let f of h)m.createEl("li").createEl("a",{text:`[${f.index}] ${f.label}`,cls:"gemini-rag-source-link"}).addEventListener("click",u=>{u.preventDefault(),this.openSource(f,!0)})}}catch(l){console.error(l),new w.Notice("Failed to generate answer. Check console for details.")}finally{this.plugin.setStatus(""),this.statusEl&&(this.statusEl.setText(""),this.statusEl.removeClass("is-active"))}}pushHistory(e,t){let s={id:`${Date.now()}-${Math.random().toString(16).slice(2)}`,timestamp:Date.now(),question:e,answer:t},n=50;this.plugin.history.unshift(s),this.plugin.history.length>n&&(this.plugin.history=this.plugin.history.slice(0,n)),this.plugin.saveSettings()}renderHistory(){if(this.chatEl){if(this.chatEl.empty(),!this.plugin.history.length){this.chatEl.createEl("div",{cls:"gemini-rag-chat-empty",text:"No messages yet."});return}for(let e of this.plugin.history){let t=this.chatEl.createEl("div",{cls:"gemini-rag-chat-bubble user"});t.createEl("div",{cls:"gemini-rag-chat-role",text:"You"}),t.createEl("div",{cls:"gemini-rag-chat-text",text:e.question});let s=this.chatEl.createEl("div",{cls:"gemini-rag-chat-bubble assistant"});s.createEl("div",{cls:"gemini-rag-chat-role",text:"Obsidian Agent"});let n=s.createEl("div",{cls:"gemini-rag-chat-text"});w.MarkdownRenderer.renderMarkdown(e.answer,n,this.plugin.app.vault.getRoot().path,this)}}}extractSources(e){return e!=null&&e.groundingChunks?e.groundingChunks.map((t,s)=>{var m,f,p,c,u;let n=(m=t.retrievedContext)!=null?m:t.retrieved_context,r=(p=(f=n==null?void 0:n.title)!=null?f:n==null?void 0:n.displayName)!=null?p:n==null?void 0:n.display_name,l=(c=n==null?void 0:n.uri)!=null?c:n==null?void 0:n.uri,o=(u=n==null?void 0:n.text)!=null?u:n==null?void 0:n.text,d=r||l||`Chunk ${s+1}`,h=o?o.slice(0,200):void 0,g=this.resolveVaultPath(r);return{label:d,detail:h,path:g,uri:l,index:s+1,text:o}}):[]}annotateAnswer(e,t,s){var d,h,g,m,f,p;if(!t)return e;let n=(h=(d=t.groundingSupports)!=null?d:t.grounding_supports)!=null?h:[];if(n.length===0)return e;let r=new Map;for(let c of n){let u=(g=c.segment)!=null?g:c.segment,k=(m=u==null?void 0:u.endIndex)!=null?m:u==null?void 0:u.end_index,v=(f=c.groundingChunkIndices)!=null?f:c.grounding_chunk_indices;if(typeof k!="number"||!Array.isArray(v))continue;let S=v.map(T=>{var A;return(A=s[T])==null?void 0:A.index}).filter(T=>typeof T=="number");if(S.length===0)continue;let E=Array.from(new Set(S)).sort((T,A)=>T-A),V=this.findSentenceEnd(e,k),K=(p=r.get(V))!=null?p:[];r.set(V,K.concat(E))}if(r.size===0)return e;let l=[];for(let[c,u]of r.entries()){let v=Array.from(new Set(u)).sort((S,E)=>S-E).map(S=>`[${S}](citation:${S})`).join(" ");l.push({pos:c,marker:` ${v}`})}l.sort((c,u)=>u.pos-c.pos);let o=e;for(let c of l)c.pos>=0&&c.pos<=o.length?o=o.slice(0,c.pos)+c.marker+o.slice(c.pos):o+=c.marker;return o}findSentenceEnd(e,t){if(t>=e.length)return e.length;let s=[".","!","?","\u3002","\uFF01","\uFF1F",`
`];for(let n=Math.max(0,t);n<e.length;n+=1){let r=e.charAt(n);if(s.includes(r))return n+1}return e.length}resolveVaultPath(e){if(!e)return;if(this.app.vault.getAbstractFileByPath(e))return e}async openSource(e,t){if(e.path){let s=this.app.vault.getAbstractFileByPath(e.path);if(s instanceof w.TFile){let n=this.app.workspace.getLeaf(!0);if(await n.openFile(s),t&&e.text){let r=n.view;r instanceof w.MarkdownView&&r.editor&&await this.highlightSnippet(r.editor,e.text,6)}return}}if(e.uri){if(e.uri.startsWith("obsidian://")){window.open(e.uri,"_blank");return}window.open(e.uri,"_blank")}}async highlightSnippet(e,t,s){let n=e.getValue(),r=t.trim();if(!r)return;let l=n.indexOf(r);if(l===-1&&(l=this.findApproximateMatch(n,r,s),l===-1))return;let o=e.offsetToPos(l),d=e.offsetToPos(l+r.length);e.setSelection(o,d),e.scrollIntoView({from:o,to:d},!0)}findApproximateMatch(e,t,s){let n=t.replace(/\s+/g," ").trim();if(n.length<s)return-1;let r=n.split(" ").filter(l=>l.length>=s);for(let l of r){let o=e.indexOf(l);if(o!==-1)return o}return-1}};async function L(a){let{workspace:i}=a.app,e=i.getLeavesOfType(b)[0];if(!e){let t=i.getRightLeaf(!1);e=t!=null?t:void 0,e||(e=i.getLeaf(!1)),await e.setViewState({type:b,active:!0})}await i.revealLeaf(e)}function _(a){a.addCommand({id:"open-gemini-rag-panel",name:"Open Obsidian Agent panel",callback:()=>L(a)}),a.addCommand({id:"index-vault-to-file-search",name:"Index vault to File Search (Obsidian Agent)",callback:()=>R(a)}),a.addCommand({id:"create-file-search-store",name:"Create File Search store (Obsidian Agent)",callback:()=>F(a)})}var C={version:1,files:{}};var M=class extends G.Plugin{constructor(){super(...arguments);this.statusListeners=new Set}async onload(){await this.loadSettings(),this.registerView(b,e=>new D(e,this)),this.addSettingTab(new N(this.app,this)),_(this),this.app.workspace.onLayoutReady(()=>{L(this)})}onunload(){this.app.workspace.detachLeavesOfType(b)}setStatus(e){for(let t of this.statusListeners)t(e)}onStatusChange(e){return this.statusListeners.add(e),()=>{this.statusListeners.delete(e)}}async loadSettings(){var t,s;let e=await this.loadData();if(e&&"settings"in e){let n=e;this.settings=Object.assign({},U,(t=n.settings)!=null?t:{}),this.indexState=Object.assign({},C,(s=n.indexState)!=null?s:{}),this.history=Array.isArray(n.history)?n.history:[]}else{let n=e!=null?e:{};this.settings=Object.assign({},U,n),this.indexState=Object.assign({},C),this.history=[]}}async saveSettings(){let e={settings:this.settings,indexState:this.indexState,history:this.history};await this.saveData(e)}async resetIndexState(){this.indexState=Object.assign({},C),await this.saveSettings()}async resetIndexStateForStore(e){this.indexState=Object.assign({},C,{storeName:e}),await this.saveSettings()}};
