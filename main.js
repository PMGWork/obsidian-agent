/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

var D=Object.defineProperty;var Y=Object.getOwnPropertyDescriptor;var Q=Object.getOwnPropertyNames;var Z=Object.prototype.hasOwnProperty;var tt=(s,i)=>{for(var t in i)D(s,t,{get:i[t],enumerable:!0})},et=(s,i,t,e)=>{if(i&&typeof i=="object"||typeof i=="function")for(let n of Q(i))!Z.call(s,n)&&n!==t&&D(s,n,{get:()=>i[n],enumerable:!(e=Y(i,n))||e.enumerable});return s};var nt=s=>et(D({},"__esModule",{value:!0}),s);var at={};tt(at,{default:()=>$});module.exports=nt(at);var z=require("obsidian");var E=require("obsidian"),M={apiKey:"",model:"gemini-2.5-flash",storeName:"",storeDisplayName:"obsidian-vault"},I=class extends E.PluginSettingTab{constructor(i,t){super(i,t),this.plugin=t}display(){let{containerEl:i}=this;i.empty(),new E.Setting(i).setName("API key").setDesc("Gemini API key. This plugin sends note contents to google for indexing and answers.").addText(t=>{t.inputEl.type="password",t.setPlaceholder("API key").setValue(this.plugin.settings.apiKey).onChange(async e=>{this.plugin.settings.apiKey=e.trim(),await this.plugin.saveSettings()})}),new E.Setting(i).setName("Model").setDesc("Model used for answering queries.").addText(t=>t.setValue(this.plugin.settings.model).onChange(async e=>{this.plugin.settings.model=e.trim(),await this.plugin.saveSettings()})),new E.Setting(i).setName("File search store name").setDesc("Full resource name").addText(t=>t.setValue(this.plugin.settings.storeName).onChange(async e=>{this.plugin.settings.storeName=e.trim(),await this.plugin.saveSettings()})),new E.Setting(i).setName("Store display name").setDesc("Used when creating a new store from the command palette.").addText(t=>t.setValue(this.plugin.settings.storeDisplayName).onChange(async e=>{this.plugin.settings.storeDisplayName=e.trim(),await this.plugin.saveSettings()})),new E.Setting(i).setName("Reset local index state").setDesc("Clears local index tracking. This does not delete remote documents.").addButton(t=>t.setButtonText("Reset").onClick(async()=>{await this.plugin.resetIndexState()}))}};var v=require("obsidian");var j=require("obsidian"),R="https://generativelanguage.googleapis.com/v1beta",it="https://generativelanguage.googleapis.com/upload/v1beta",k=class{constructor(i){this.apiKey=i}async createFileSearchStore(i){return await this.request(`${R}/fileSearchStores`,{method:"POST",body:JSON.stringify({displayName:i})})}async deleteFileSearchStore(i,t=!0){let e=new URL(`${R}/${i}`);t&&e.searchParams.set("force","true"),await this.request(e.toString(),{method:"DELETE"})}async uploadMarkdownToStore(i,t){let e=await fetch(`${it}/${i}:uploadToFileSearchStore`,{method:"POST",headers:{"x-goog-api-key":this.apiKey,"X-Goog-Upload-Protocol":"resumable","X-Goog-Upload-Command":"start","X-Goog-Upload-Header-Content-Length":String(t.bytes.byteLength),"X-Goog-Upload-Header-Content-Type":"text/markdown","Content-Type":"application/json"},body:JSON.stringify({displayName:t.displayName,mimeType:"text/markdown",customMetadata:t.metadata})});if(!e.ok)throw new Error(`Upload start failed: ${await e.text()}`);let n=e.headers.get("x-goog-upload-url");if(!n)throw new Error("Upload URL missing from response.");let r=await fetch(n,{method:"POST",headers:{"X-Goog-Upload-Command":"upload, finalize","X-Goog-Upload-Offset":"0"},body:new Blob([t.bytes.slice().buffer],{type:"text/markdown"})});if(!r.ok)throw new Error(`Upload finalize failed: ${await r.text()}`);return await r.json()}async waitForOperation(i,t=12e4){var n;let e=Date.now();for(;Date.now()-e<t;){let r=await this.request(`${R}/${i}`,{method:"GET"});if(r.done){if((n=r.error)!=null&&n.message)throw new Error(r.error.message);return}await this.delay(1e3)}throw new Error("Indexing timed out.")}async generateContent(i,t,e,n=[],r){let a=[];for(let o of n)a.push({role:"user",parts:[{text:o.question}]}),a.push({role:"model",parts:[{text:o.answer}]});return a.push({role:"user",parts:[{text:e}]}),await this.request(`${R}/models/${i}:generateContent`,{method:"POST",body:JSON.stringify({contents:a,tools:[{fileSearch:{fileSearchStoreNames:[t]}}],generationConfig:r?{thinkingConfig:{includeThoughts:!0}}:void 0})})}async generateContentStream(i,t,e,n,r=[],a){var w;let o=[];for(let d of r)o.push({role:"user",parts:[{text:d.question}]}),o.push({role:"model",parts:[{text:d.answer}]});o.push({role:"user",parts:[{text:e}]});let l=await fetch(`${R}/models/${i}:streamGenerateContent?alt=sse`,{method:"POST",headers:{"x-goog-api-key":this.apiKey,"Content-Type":"application/json"},body:JSON.stringify({contents:o,tools:[{fileSearch:{fileSearchStoreNames:[t]}}],generationConfig:a?{thinkingConfig:{includeThoughts:!0}}:void 0})});if(!l.ok||!l.body)throw new Error(await l.text());let p=l.body.getReader(),c=new TextDecoder,u="";for(;;){let{done:d,value:m}=await p.read();if(d)break;let g=c.decode(m,{stream:!0});u+=g;let h=u.split(`
`);u=(w=h.pop())!=null?w:"";for(let f of h)if(f.startsWith("data: ")){let y=f.slice(6);try{let S=JSON.parse(y);await n(S)}catch(S){console.error("Failed to parse stream chunk",S)}}}}extractAnswer(i){var p,c,u,w,d;let t=(p=i.candidates)==null?void 0:p[0],e=(u=(c=t==null?void 0:t.content)==null?void 0:c.parts)!=null?u:[],n=[],r=[];for(let m of e){let g=(w=m.text)!=null?w:"";g&&(m.thought?n.push(g):r.push(g))}let a=r.join(""),o=n.join(""),l=(d=t==null?void 0:t.groundingMetadata)!=null?d:t==null?void 0:t.grounding_metadata;return{text:a,grounding:l,thoughtSummary:o||void 0}}async request(i,t){let e={url:i,method:t.method,headers:{"x-goog-api-key":this.apiKey,"Content-Type":"application/json"},body:t.body,throw:!1},n=await(0,j.requestUrl)(e);if(n.status>=400)throw new Error(n.text);return n.status===204?{}:n.json}async delay(i){return new Promise(t=>window.setTimeout(t,i))}};var A=require("obsidian");function st(s){var i,t;return(t=(i=s.stat)==null?void 0:i.mtime)!=null?t:0}async function O(s){var a,o;let i=s.settings.apiKey,t=s.settings.storeName;if(!i){new A.Notice("API key is not set.");return}if(!t){new A.Notice("File search store name is not set.");return}s.indexState.storeName!==t&&await s.resetIndexStateForStore(t);let e=s.app.vault.getMarkdownFiles(),n=new k(i),r={total:e.length,indexed:0,skipped:0};s.setStatus(`Indexing ${e.length} files...`);for(let l of e){let p=st(l),c=(o=(a=s.indexState.files[l.path])==null?void 0:a.mtime)!=null?o:0;if(p<=c){r.skipped+=1;continue}try{let u=await rt(s,n,t,l,p);u!=null&&u.name&&await n.waitForOperation(u.name),s.indexState.files[l.path]={mtime:p},r.indexed+=1,s.setStatus(`Indexed ${r.indexed}/${r.total} (skipped ${r.skipped})`),await s.saveSettings()}catch(u){console.error(u),new A.Notice(`Failed to index ${l.path}`)}}s.setStatus(`Index complete. Indexed ${r.indexed}, skipped ${r.skipped}.`),new A.Notice(`Index complete. Indexed ${r.indexed}, skipped ${r.skipped}.`)}async function rt(s,i,t,e,n){let r=await s.app.vault.read(e),a=new TextEncoder().encode(r);if(a.byteLength>100*1024*1024)throw new Error(`File too large: ${e.path}`);let o=[{key:"vault",stringValue:s.app.vault.getName()},{key:"path",stringValue:e.path},{key:"mtime",numericValue:n}];return await i.uploadMarkdownToStore(t,{displayName:e.path,bytes:a,metadata:o})}var L=require("obsidian");async function F(s){var n,r;let i=s.settings.apiKey;if(!i){new L.Notice("API key is not set.");return}let t=s.settings.storeDisplayName||"obsidian-vault",e=new k(i);try{s.settings.storeName&&(s.setStatus("Deleting existing File Search store..."),await e.deleteFileSearchStore(s.settings.storeName,!0)),s.setStatus("Creating File Search store...");let a=await e.createFileSearchStore(t);s.settings.storeName=(n=a.name)!=null?n:"",await s.resetIndexStateForStore(s.settings.storeName),await s.saveSettings(),new L.Notice(`Store created: ${(r=a.name)!=null?r:"unknown"}`)}catch(a){console.error(a),new L.Notice("Failed to create store. Check console for details.")}finally{s.setStatus("")}}function G(s,i){return s!=null&&s.groundingChunks?s.groundingChunks.map((t,e)=>{var u,w,d,m,g;let n=(u=t.retrievedContext)!=null?u:t.retrieved_context,r=(d=(w=n==null?void 0:n.title)!=null?w:n==null?void 0:n.displayName)!=null?d:n==null?void 0:n.display_name,a=(m=n==null?void 0:n.uri)!=null?m:n==null?void 0:n.uri,o=(g=n==null?void 0:n.text)!=null?g:n==null?void 0:n.text,l=r||a||`Chunk ${e+1}`,p=o?o.slice(0,200):void 0,c=i(r);return{label:l,detail:p,path:c,uri:a,index:e+1,text:o}}):[]}function U(s,i,t){var o,l,p,c,u,w;if(!i)return s;let e=(l=(o=i.groundingSupports)!=null?o:i.grounding_supports)!=null?l:[];if(e.length===0)return s;let n=new Map;for(let d of e){let m=(p=d.segment)!=null?p:d.segment,g=(c=m==null?void 0:m.endIndex)!=null?c:m==null?void 0:m.end_index,h=(u=d.groundingChunkIndices)!=null?u:d.grounding_chunk_indices;if(typeof g!="number"||!Array.isArray(h))continue;let f=h.map(x=>{var b;return(b=t[x])==null?void 0:b.index}).filter(x=>typeof x=="number");if(f.length===0)continue;let y=Array.from(new Set(f)).sort((x,b)=>x-b),S=(w=n.get(g))!=null?w:[];n.set(g,S.concat(y))}if(n.size===0)return s;let r=[];for(let[d,m]of n.entries()){let h=Array.from(new Set(m)).sort((f,y)=>f-y).map(f=>`[${f}](citation:${f})`).join(" ");r.push({pos:d,marker:h})}r.sort((d,m)=>m.pos-d.pos);let a=s;for(let d of r)d.pos>=0&&d.pos<=a.length?a=a.slice(0,d.pos)+d.marker+a.slice(d.pos):a+=d.marker;return a}var q=require("obsidian");function H(s,i){if(!i)return;if(s.vault.getAbstractFileByPath(i))return i;let e=i.replace(/\.md$/i,""),n=s.vault.getFiles();for(let r of n)if(r.basename===e)return r.path}async function W(s,i){if(i.path){let t=s.vault.getAbstractFileByPath(i.path);if(t instanceof q.TFile){await s.workspace.getLeaf(!0).openFile(t);return}}i.uri&&window.open(i.uri,"_blank")}var C="gemini-file-search-rag-view",T=class extends v.ItemView{constructor(t,e){super(t);this.sourcesMap=new Map;this.plugin=e}getViewType(){return C}getDisplayText(){return"Obsidian agent"}async onOpen(){this.render()}render(){let{contentEl:t}=this;t.empty(),t.addClass("gemini-rag-view");let e=t.createEl("div",{cls:"gemini-rag-header"});e.createEl("div",{cls:"gemini-rag-title-wrap"}).createEl("h2",{text:"Obsidian agent"});let a=e.createEl("div",{cls:"gemini-rag-header-actions"}).createEl("button",{cls:"gemini-rag-icon-btn",attr:{"aria-label":"New chat",title:"New chat"}});(0,v.setIcon)(a,"circle-plus");let o=t.createEl("div",{cls:"gemini-rag-main"});this.chatEl=o.createEl("div",{cls:"gemini-rag-chat"}),this.chatEl.addEventListener("click",g=>{let h=g.target;if(!h)return;let f=h.closest("a");if(!f)return;let y=f.getAttribute("href");if(!y||!y.startsWith("citation:"))return;g.preventDefault();let S=y.replace("citation:",""),x=Number(S);if(!Number.isFinite(x))return;let b=this.sourcesMap.get(x);b&&W(this.app,b)}),this.chatEl.addEventListener("mouseover",g=>{let h=g.target;if(!h)return;let f=h.closest("a");if(!f)return;let y=f.getAttribute("href");if(!y||!y.startsWith("citation:"))return;let S=y.replace("citation:",""),x=Number(S);if(!Number.isFinite(x))return;let b=this.sourcesMap.get(x);b&&this.showTooltip(f,b)}),this.chatEl.addEventListener("mouseout",g=>{let h=g.target;if(!h)return;let f=h.closest("a");if(!f)return;let y=f.getAttribute("href");!y||!y.startsWith("citation:")||this.hideTooltip()}),this.renderHistory();let l=t.createEl("div",{cls:"gemini-rag-controls"}),p=l.createEl("textarea",{cls:"gemini-rag-input",attr:{rows:"5",placeholder:"Ask something about your notes..."}});this.hintEl=l.createEl("div",{cls:"gemini-rag-hint"}),this.hintEl.setText("\u2318/Ctrl + Enter \u3067\u9001\u4FE1");let c=l.createEl("div",{cls:"gemini-rag-buttons"}),u=c.createEl("button",{cls:"gemini-rag-btn is-primary",text:"Ask"}),w=c.createEl("button",{cls:"gemini-rag-btn",text:"Index vault"}),d=c.createEl("button",{cls:"gemini-rag-btn",text:"Create store"}),m=async()=>{let g=p.value.trim();g&&(p.value="",await this.ask(g))};a.addEventListener("click",()=>{this.clearChat()}),u.addEventListener("click",()=>{m()}),p.addEventListener("keydown",g=>{(g.metaKey||g.ctrlKey)&&g.key==="Enter"&&(g.preventDefault(),m())}),w.addEventListener("click",()=>{O(this.plugin)}),d.addEventListener("click",()=>{F(this.plugin)})}async clearChat(){this.plugin.history=[],await this.plugin.saveSettings(),this.sourcesMap.clear(),this.renderHistory()}async ask(t){let e=this.plugin.settings.apiKey,n=this.plugin.settings.storeName,r=this.plugin.settings.model;if(!e){new v.Notice("API key is not set.");return}if(!n){new v.Notice("File search store name is not set.");return}let a=new k(e);try{this.plugin.setStatus("Generating answer...");let o=this.plugin.history.slice(-10),l="",p="",c;if(!this.chatEl)return;let w=this.chatEl.createEl("div",{cls:"gemini-rag-chat-bubble assistant"}).createEl("div",{cls:"gemini-rag-chat-text"});await a.generateContentStream(r,n,t,async h=>{var _,V,B,K;let{text:f,grounding:y,thoughtSummary:S}=a.extractAnswer(h);f&&(l+=f),S&&(p+=S),y&&(c={...c,...y,groundingChunks:[...(_=c==null?void 0:c.groundingChunks)!=null?_:[],...(V=y.groundingChunks)!=null?V:[]],groundingSupports:[...(B=c==null?void 0:c.groundingSupports)!=null?B:[],...(K=y.groundingSupports)!=null?K:[]]});let x=U(l,c,G(c,()=>"")),b=this.formatOutput(x,p);w.empty(),await v.MarkdownRenderer.render(this.plugin.app,b,w,this.plugin.app.vault.getRoot().path,this)},o,!0);let d=G(c,h=>H(this.app,h));this.sourcesMap.clear();for(let h of d)this.sourcesMap.set(h.index,h);let m=U(l,c,d),g=this.formatOutput(m,p);w.empty(),await v.MarkdownRenderer.render(this.plugin.app,g,w,this.plugin.app.vault.getRoot().path,this),this.pushHistory(t,g)}catch(o){console.error(o),new v.Notice("Failed to generate answer. Check console for details.")}finally{this.plugin.setStatus("")}}formatOutput(t,e){let n="\u63A8\u8AD6\u306E\u8981\u7D04",r=e==null?void 0:e.trim();if(!r)return t;let a=`> [!info]- ${n}
> ${r.replace(/\n/g,`
> `)}`;return t.trim()?`${a}

${t}`:a}pushHistory(t,e){let n={id:`${Date.now()}-${Math.random().toString(16).slice(2)}`,timestamp:Date.now(),question:t,answer:e},r=50;this.plugin.history.push(n),this.plugin.history.length>r&&(this.plugin.history=this.plugin.history.slice(-r)),this.plugin.saveSettings()}renderHistory(){if(this.chatEl){if(this.chatEl.empty(),!this.plugin.history.length){this.chatEl.createEl("div",{cls:"gemini-rag-chat-empty",text:"No messages yet."});return}for(let t of this.plugin.history){this.chatEl.createEl("div",{cls:"gemini-rag-chat-bubble user"}).createEl("div",{cls:"gemini-rag-chat-text",text:t.question});let r=this.chatEl.createEl("div",{cls:"gemini-rag-chat-bubble assistant"}).createEl("div",{cls:"gemini-rag-chat-text"});v.MarkdownRenderer.render(this.plugin.app,t.answer,r,this.plugin.app.vault.getRoot().path,this)}}}showTooltip(t,e){this.hideTooltip();let n=document.createElement("div");n.className="gemini-rag-tooltip";let r=n.createEl("div",{cls:"gemini-rag-tooltip-header"});if(r.createEl("span",{cls:"gemini-rag-tooltip-icon",text:"\u{1F4C4}"}),r.createEl("span",{cls:"gemini-rag-tooltip-title",text:e.label}),e.text){let c=e.text.slice(0,150).trim(),u=c.length<e.text.length?c+"...":c;n.createEl("div",{cls:"gemini-rag-tooltip-body",text:u})}else e.detail&&n.createEl("div",{cls:"gemini-rag-tooltip-body",text:e.detail});document.body.appendChild(n),this.tooltipEl=n;let a=t.getBoundingClientRect(),o=n.getBoundingClientRect(),l=a.left+a.width/2-o.width/2,p=a.bottom+8;l<8&&(l=8),l+o.width>window.innerWidth-8&&(l=window.innerWidth-o.width-8),p+o.height>window.innerHeight-8&&(p=a.top-o.height-8),n.style.left=`${l}px`,n.style.top=`${p}px`}hideTooltip(){this.tooltipEl&&(this.tooltipEl.remove(),this.tooltipEl=void 0)}};async function P(s){let{workspace:i}=s.app,t=i.getLeavesOfType(C)[0];if(!t){let e=i.getRightLeaf(!1);t=e!=null?e:void 0,t||(t=i.getLeaf(!1)),await t.setViewState({type:C,active:!0})}await i.revealLeaf(t)}async function X(s){await P(s);let i=s.app.workspace.getLeavesOfType(C);if(i.length===0){s.history=[],await s.saveSettings();return}for(let t of i){let e=t.view;e instanceof T&&await e.clearChat()}}function J(s){s.addCommand({id:"open-gemini-rag-panel",name:"Open panel",callback:()=>P(s)}),s.addCommand({id:"new-chat",name:"New chat",callback:()=>X(s)}),s.addCommand({id:"index-vault-to-file-search",name:"Index vault to file search",callback:()=>O(s)}),s.addCommand({id:"create-file-search-store",name:"Create file search store",callback:()=>F(s)})}var N={version:1,files:{}};var $=class extends z.Plugin{constructor(){super(...arguments);this.statusListeners=new Set}async onload(){await this.loadSettings(),this.registerView(C,t=>new T(t,this)),this.addSettingTab(new I(this.app,this)),J(this),this.app.workspace.onLayoutReady(()=>{P(this)})}setStatus(t){for(let e of this.statusListeners)e(t)}onStatusChange(t){return this.statusListeners.add(t),()=>{this.statusListeners.delete(t)}}async loadSettings(){var e,n;let t=await this.loadData();if(t&&"settings"in t)this.settings=Object.assign({},M,(e=t.settings)!=null?e:{}),this.indexState=Object.assign({},N,(n=t.indexState)!=null?n:{}),this.history=Array.isArray(t.history)?t.history:[];else{let r=t!=null?t:{};this.settings=Object.assign({},M,r),this.indexState=Object.assign({},N),this.history=[]}}async saveSettings(){let t={settings:this.settings,indexState:this.indexState,history:this.history};await this.saveData(t)}async resetIndexState(){this.indexState=Object.assign({},N),await this.saveSettings()}async resetIndexStateForStore(t){this.indexState=Object.assign({},N,{storeName:t}),await this.saveSettings()}};
