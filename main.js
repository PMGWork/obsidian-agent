/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

var I=Object.defineProperty;var U=Object.getOwnPropertyDescriptor;var $=Object.getOwnPropertyNames;var K=Object.prototype.hasOwnProperty;var M=(i,t)=>{for(var e in t)I(i,e,{get:t[e],enumerable:!0})},V=(i,t,e,n)=>{if(t&&typeof t=="object"||typeof t=="function")for(let s of $(t))!K.call(i,s)&&s!==e&&I(i,s,{get:()=>t[s],enumerable:!(n=U(t,s))||n.enumerable});return i};var j=i=>V(I({},"__esModule",{value:!0}),i);var X={};M(X,{default:()=>A});module.exports=j(X);var D=require("obsidian");var h=require("obsidian"),N={apiKey:"",model:"gemini-2.5-flash",storeName:"",storeDisplayName:"obsidian-vault"},k=class extends h.PluginSettingTab{constructor(t,e){super(t,e),this.plugin=e}display(){let{containerEl:t}=this;t.empty(),t.createEl("h2",{text:"Gemini RAG settings"}),new h.Setting(t).setName("API key").setDesc("Gemini API key. This plugin sends note contents to Google for indexing and answers.").addText(e=>{e.inputEl.type="password",e.setPlaceholder("AI Studio API key").setValue(this.plugin.settings.apiKey).onChange(async n=>{this.plugin.settings.apiKey=n.trim(),await this.plugin.saveSettings()})}),new h.Setting(t).setName("Model").setDesc("Model used for answering queries.").addText(e=>e.setPlaceholder("gemini-2.5-flash").setValue(this.plugin.settings.model).onChange(async n=>{this.plugin.settings.model=n.trim(),await this.plugin.saveSettings()})),new h.Setting(t).setName("File Search store name").setDesc("Full resource name, for example: fileSearchStores/1234567890").addText(e=>e.setPlaceholder("fileSearchStores/...").setValue(this.plugin.settings.storeName).onChange(async n=>{this.plugin.settings.storeName=n.trim(),await this.plugin.saveSettings()})),new h.Setting(t).setName("Store display name").setDesc("Used when creating a new store from the command palette.").addText(e=>e.setPlaceholder("obsidian-vault").setValue(this.plugin.settings.storeDisplayName).onChange(async n=>{this.plugin.settings.storeDisplayName=n.trim(),await this.plugin.saveSettings()})),new h.Setting(t).setName("Reset local index state").setDesc("Clears local index tracking. This does not delete remote documents.").addButton(e=>e.setButtonText("Reset").onClick(async()=>{await this.plugin.resetIndexState()}))}};var w=require("obsidian");var O="https://generativelanguage.googleapis.com/v1beta",B="https://generativelanguage.googleapis.com/upload/v1beta",f=class{constructor(t){this.apiKey=t}async createFileSearchStore(t){return await this.request(`${O}/fileSearchStores`,{method:"POST",body:JSON.stringify({displayName:t})})}async uploadMarkdownToStore(t,e){let n=await fetch(`${B}/${t}:uploadToFileSearchStore`,{method:"POST",headers:{"x-goog-api-key":this.apiKey,"X-Goog-Upload-Protocol":"resumable","X-Goog-Upload-Command":"start","X-Goog-Upload-Header-Content-Length":String(e.bytes.byteLength),"X-Goog-Upload-Header-Content-Type":"text/markdown","Content-Type":"application/json"},body:JSON.stringify({displayName:e.displayName,mimeType:"text/markdown"})});if(!n.ok)throw new Error(`Upload start failed: ${await n.text()}`);let s=n.headers.get("x-goog-upload-url");if(!s)throw new Error("Upload URL missing from response.");let a=await fetch(s,{method:"POST",headers:{"X-Goog-Upload-Command":"upload, finalize","X-Goog-Upload-Offset":"0"},body:e.bytes});if(!a.ok)throw new Error(`Upload finalize failed: ${await a.text()}`);return await a.json()}async waitForOperation(t,e=12e4){var s;let n=Date.now();for(;Date.now()-n<e;){let a=await this.request(`${O}/${t}`,{method:"GET"});if(a.done){if((s=a.error)!=null&&s.message)throw new Error(a.error.message);return}await this.delay(1e3)}throw new Error("Indexing timed out.")}async generateContent(t,e,n){return await this.request(`${O}/models/${t}:generateContent`,{method:"POST",body:JSON.stringify({contents:[{role:"user",parts:[{text:n}]}],tools:[{fileSearch:{fileSearchStoreNames:[e]}}]})})}extractAnswer(t){var r,d,l,g;let e=(r=t.candidates)==null?void 0:r[0],s=((l=(d=e==null?void 0:e.content)==null?void 0:d.parts)!=null?l:[]).map(m=>{var p;return(p=m.text)!=null?p:""}).join(""),a=(g=e==null?void 0:e.groundingMetadata)!=null?g:e==null?void 0:e.grounding_metadata;return{text:s,grounding:a}}async request(t,e){var s;let n=await fetch(t,{...e,headers:{"x-goog-api-key":this.apiKey,"Content-Type":"application/json",...(s=e.headers)!=null?s:{}}});if(!n.ok)throw new Error(await n.text());return n.status===204?{}:n.json()}async delay(t){return new Promise(e=>window.setTimeout(e,t))}};var E=require("obsidian");function q(i){var t,e;return(e=(t=i.stat)==null?void 0:t.mtime)!=null?e:0}async function b(i){var r,d;let t=i.settings.apiKey,e=i.settings.storeName;if(!t){new E.Notice("API key is not set.");return}if(!e){new E.Notice("File Search store name is not set.");return}let n=i.app.vault.getMarkdownFiles(),s=new f(t),a={total:n.length,indexed:0,skipped:0};i.setStatus(`Indexing ${n.length} files...`);for(let l of n){let g=q(l),m=(d=(r=i.indexState.files[l.path])==null?void 0:r.mtime)!=null?d:0;if(g<=m){a.skipped+=1;continue}try{await W(i,s,e,l),i.indexState.files[l.path]={mtime:g},a.indexed+=1,i.setStatus(`Indexed ${a.indexed}/${a.total} (skipped ${a.skipped})`),await i.saveSettings()}catch(p){console.error(p),new E.Notice(`Failed to index ${l.path}`)}}i.setStatus(`Index complete. Indexed ${a.indexed}, skipped ${a.skipped}.`),new E.Notice(`Index complete. Indexed ${a.indexed}, skipped ${a.skipped}.`)}async function W(i,t,e,n){let s=await i.app.vault.read(n),a=new TextEncoder().encode(s);if(a.byteLength>100*1024*1024)throw new Error(`File too large: ${n.path}`);let r=await t.uploadMarkdownToStore(e,{displayName:n.path,bytes:a});r!=null&&r.name&&await t.waitForOperation(r.name)}var T=require("obsidian");async function P(i){var s,a;let t=i.settings.apiKey;if(!t){new T.Notice("API key is not set.");return}let e=i.settings.storeDisplayName||"obsidian-vault",n=new f(t);try{i.setStatus("Creating File Search store...");let r=await n.createFileSearchStore(e);i.settings.storeName=(s=r.name)!=null?s:"",await i.saveSettings(),new T.Notice(`Store created: ${(a=r.name)!=null?a:"unknown"}`)}catch(r){console.error(r),new T.Notice("Failed to create store. Check console for details.")}finally{i.setStatus("")}}var S="gemini-file-search-rag-view",C=class extends w.ItemView{constructor(t,e){super(t),this.plugin=e}getViewType(){return S}getDisplayText(){return"Gemini RAG"}async onOpen(){this.render(),this.cleanupStatus=this.plugin.onStatusChange(t=>{this.statusEl&&(this.statusEl.setText(t),t?this.statusEl.addClass("is-active"):this.statusEl.removeClass("is-active"))})}async onClose(){this.cleanupStatus&&this.cleanupStatus()}render(){let{contentEl:t}=this;t.empty(),t.addClass("gemini-rag-view");let e=t.createEl("div",{cls:"gemini-rag-header"}),n=e.createEl("div",{cls:"gemini-rag-title-wrap"});n.createEl("div",{cls:"gemini-rag-kicker",text:"Knowledge panel"}),n.createEl("h2",{text:"Gemini RAG"}),this.statusEl=e.createEl("div",{cls:"gemini-rag-status-pill"});let s=t.createEl("div",{cls:"gemini-rag-controls"});s.createEl("div",{cls:"gemini-rag-label"}).setText("Ask about your notes");let r=s.createEl("textarea",{cls:"gemini-rag-input",attr:{rows:"5",placeholder:"\u4F8B: \u3053\u306E\u9031\u306E\u9032\u6357\u307E\u3068\u3081\u3068\u8AB2\u984C\u306F\uFF1F"}});this.hintEl=s.createEl("div",{cls:"gemini-rag-hint"}),this.hintEl.setText("\u2318/Ctrl + Enter \u3067\u9001\u4FE1");let d=s.createEl("div",{cls:"gemini-rag-buttons"}),l=d.createEl("button",{cls:"gemini-rag-btn primary",text:"Ask"}),g=d.createEl("button",{cls:"gemini-rag-btn",text:"Index vault"}),m=d.createEl("button",{cls:"gemini-rag-btn ghost",text:"Create store"}),p=async()=>{let u=r.value.trim();u&&await this.ask(u)};l.addEventListener("click",p),r.addEventListener("keydown",async u=>{(u.metaKey||u.ctrlKey)&&u.key==="Enter"&&(u.preventDefault(),await p())}),g.addEventListener("click",async()=>{await b(this.plugin)}),m.addEventListener("click",async()=>{await P(this.plugin)});let o=t.createEl("div",{cls:"gemini-rag-section"});o.createEl("h3",{text:"Answer"}),this.answerEl=o.createEl("div",{cls:"gemini-rag-answer"});let c=t.createEl("div",{cls:"gemini-rag-section"});c.createEl("h3",{text:"Sources"}),this.sourcesEl=c.createEl("div",{cls:"gemini-rag-sources"})}async ask(t){let e=this.plugin.settings.apiKey,n=this.plugin.settings.storeName,s=this.plugin.settings.model;if(!e){new w.Notice("API key is not set.");return}if(!n){new w.Notice("File Search store name is not set.");return}let a=new f(e);try{this.plugin.setStatus("Generating answer..."),this.statusEl&&(this.statusEl.setText("Thinking..."),this.statusEl.addClass("is-active")),this.answerEl&&this.answerEl.setText(""),this.sourcesEl&&this.sourcesEl.setText("");let r=await a.generateContent(s,n,t),{text:d,grounding:l}=a.extractAnswer(r),g=this.extractSources(l),m=this.annotateAnswer(d,l,g);if(this.answerEl&&this.answerEl.createEl("div",{text:m}),this.sourcesEl)if(g.length===0)this.sourcesEl.createEl("div",{text:"No sources returned."});else{let p=this.sourcesEl.createEl("ol");for(let o of g){let c=p.createEl("li");c.createEl("a",{text:`[${o.index}] ${o.label}`,cls:"gemini-rag-source-link"}).addEventListener("click",y=>{y.preventDefault(),this.openSource(o)}),o.detail&&c.createEl("div",{text:o.detail,cls:"gemini-rag-source-detail"})}}}catch(r){console.error(r),new w.Notice("Failed to generate answer. Check console for details.")}finally{this.plugin.setStatus(""),this.statusEl&&(this.statusEl.setText(""),this.statusEl.removeClass("is-active"))}}extractSources(t){return t!=null&&t.groundingChunks?t.groundingChunks.map((e,n)=>{var p,o,c,u,y;let s=(p=e.retrievedContext)!=null?p:e.retrieved_context,a=(c=(o=s==null?void 0:s.title)!=null?o:s==null?void 0:s.displayName)!=null?c:s==null?void 0:s.display_name,r=(u=s==null?void 0:s.uri)!=null?u:s==null?void 0:s.uri,d=(y=s==null?void 0:s.text)!=null?y:s==null?void 0:s.text,l=a||r||`Chunk ${n+1}`,g=d?d.slice(0,200):void 0,m=this.resolveVaultPath(a);return{label:l,detail:g,path:m,uri:r,index:n+1}}):[]}annotateAnswer(t,e,n){var d,l,g,m,p;if(!e)return t;let s=(l=(d=e.groundingSupports)!=null?d:e.grounding_supports)!=null?l:[];if(s.length===0)return t;let a=[];for(let o of s){let c=(g=o.segment)!=null?g:o.segment,u=(m=c==null?void 0:c.endIndex)!=null?m:c==null?void 0:c.end_index,y=(p=o.groundingChunkIndices)!=null?p:o.grounding_chunk_indices;if(typeof u!="number"||!Array.isArray(y))continue;let G=y.map(x=>{var v;return(v=n[x])==null?void 0:v.index}).filter(x=>typeof x=="number");if(G.length===0)continue;let _=Array.from(new Set(G)).sort((x,v)=>x-v);a.push({pos:u,marker:` [${_.join(", ")}]`})}if(a.length===0)return t;a.sort((o,c)=>c.pos-o.pos);let r=t;for(let o of a)o.pos>=0&&o.pos<=r.length?r=r.slice(0,o.pos)+o.marker+r.slice(o.pos):r+=o.marker;return r}resolveVaultPath(t){if(!t)return;if(this.app.vault.getAbstractFileByPath(t))return t}async openSource(t){if(t.path){let e=this.app.vault.getAbstractFileByPath(t.path);if(e instanceof w.TFile){await this.app.workspace.getLeaf(!0).openFile(e);return}}if(t.uri){if(t.uri.startsWith("obsidian://")){window.open(t.uri,"_blank");return}window.open(t.uri,"_blank")}}};async function L(i){let{workspace:t}=i.app,e=t.getLeavesOfType(S)[0];if(!e){let n=t.getRightLeaf(!1);e=n!=null?n:void 0,e||(e=t.getLeaf(!1)),await e.setViewState({type:S,active:!0})}await t.revealLeaf(e)}function F(i){i.addCommand({id:"open-gemini-rag-panel",name:"Open Gemini RAG panel",callback:()=>L(i)}),i.addCommand({id:"index-vault-to-file-search",name:"Index vault to File Search",callback:()=>b(i)}),i.addCommand({id:"create-file-search-store",name:"Create File Search store",callback:()=>P(i)})}var R={version:1,files:{}};var A=class extends D.Plugin{constructor(){super(...arguments);this.statusListeners=new Set}async onload(){await this.loadSettings(),this.registerView(S,e=>new C(e,this)),this.addSettingTab(new k(this.app,this)),F(this)}onunload(){this.app.workspace.detachLeavesOfType(S)}setStatus(e){for(let n of this.statusListeners)n(e)}onStatusChange(e){return this.statusListeners.add(e),()=>{this.statusListeners.delete(e)}}async loadSettings(){var n,s;let e=await this.loadData();if(e&&"settings"in e){let a=e;this.settings=Object.assign({},N,(n=a.settings)!=null?n:{}),this.indexState=Object.assign({},R,(s=a.indexState)!=null?s:{})}else{let a=e!=null?e:{};this.settings=Object.assign({},N,a),this.indexState=Object.assign({},R)}}async saveSettings(){let e={settings:this.settings,indexState:this.indexState};await this.saveData(e)}async resetIndexState(){this.indexState=Object.assign({},R),await this.saveSettings()}};
