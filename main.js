/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

var U=Object.defineProperty;var K=Object.getOwnPropertyDescriptor;var H=Object.getOwnPropertyNames;var q=Object.prototype.hasOwnProperty;var W=(a,s)=>{for(var e in s)U(a,e,{get:s[e],enumerable:!0})},j=(a,s,e,t)=>{if(s&&typeof s=="object"||typeof s=="function")for(let i of H(s))!q.call(a,i)&&i!==e&&U(a,i,{get:()=>s[i],enumerable:!(t=K(s,i))||t.enumerable});return a};var X=a=>j(U({},"__esModule",{value:!0}),a);var Z={};W(Z,{default:()=>$});module.exports=X(Z);var B=require("obsidian");var w=require("obsidian"),V={apiKey:"",model:"gemini-2.5-flash",storeName:"",storeDisplayName:"obsidian-vault",metadataFilter:"",chunkingEnabled:!0,maxTokensPerChunk:200,maxOverlapTokens:20},A=class extends w.PluginSettingTab{constructor(s,e){super(s,e),this.plugin=e}display(){let{containerEl:s}=this;s.empty(),s.createEl("h2",{text:"Gemini RAG settings"}),new w.Setting(s).setName("API key").setDesc("Gemini API key. This plugin sends note contents to Google for indexing and answers.").addText(e=>{e.inputEl.type="password",e.setPlaceholder("AI Studio API key").setValue(this.plugin.settings.apiKey).onChange(async t=>{this.plugin.settings.apiKey=t.trim(),await this.plugin.saveSettings()})}),new w.Setting(s).setName("Model").setDesc("Model used for answering queries.").addText(e=>e.setPlaceholder("gemini-2.5-flash").setValue(this.plugin.settings.model).onChange(async t=>{this.plugin.settings.model=t.trim(),await this.plugin.saveSettings()})),new w.Setting(s).setName("File Search store name").setDesc("Full resource name, for example: fileSearchStores/1234567890").addText(e=>e.setPlaceholder("fileSearchStores/...").setValue(this.plugin.settings.storeName).onChange(async t=>{this.plugin.settings.storeName=t.trim(),await this.plugin.saveSettings()})),new w.Setting(s).setName("Store display name").setDesc("Used when creating a new store from the command palette.").addText(e=>e.setPlaceholder("obsidian-vault").setValue(this.plugin.settings.storeDisplayName).onChange(async t=>{this.plugin.settings.storeDisplayName=t.trim(),await this.plugin.saveSettings()})),new w.Setting(s).setName("Metadata filter").setDesc('Optional: filter sources by metadata (AIP-160 syntax). Example: author="Alice"').addText(e=>e.setPlaceholder('author="Alice"').setValue(this.plugin.settings.metadataFilter).onChange(async t=>{this.plugin.settings.metadataFilter=t.trim(),await this.plugin.saveSettings()})),new w.Setting(s).setName("Chunking config").setDesc("Use custom chunk sizes for File Search indexing (white-space chunking).").addToggle(e=>e.setValue(this.plugin.settings.chunkingEnabled).onChange(async t=>{this.plugin.settings.chunkingEnabled=t,await this.plugin.saveSettings()})),new w.Setting(s).setName("Max tokens per chunk").setDesc("Used when chunking is enabled. Default is 200.").addText(e=>e.setPlaceholder("200").setValue(String(this.plugin.settings.maxTokensPerChunk)).onChange(async t=>{let i=Number.parseInt(t,10);!Number.isNaN(i)&&i>0&&(this.plugin.settings.maxTokensPerChunk=i,await this.plugin.saveSettings())})),new w.Setting(s).setName("Max overlap tokens").setDesc("Used when chunking is enabled. Default is 20.").addText(e=>e.setPlaceholder("20").setValue(String(this.plugin.settings.maxOverlapTokens)).onChange(async t=>{let i=Number.parseInt(t,10);!Number.isNaN(i)&&i>=0&&(this.plugin.settings.maxOverlapTokens=i,await this.plugin.saveSettings())})),new w.Setting(s).setName("Reset local index state").setDesc("Clears local index tracking. This does not delete remote documents.").addButton(e=>e.setButtonText("Reset").onClick(async()=>{await this.plugin.resetIndexState()}))}};var f=require("obsidian");var O="https://generativelanguage.googleapis.com/v1beta",z="https://generativelanguage.googleapis.com/upload/v1beta",k=class{constructor(s){this.apiKey=s}async createFileSearchStore(s){return await this.request(`${O}/fileSearchStores`,{method:"POST",body:JSON.stringify({displayName:s})})}async deleteFileSearchStore(s,e=!0){let t=new URL(`${O}/${s}`);e&&t.searchParams.set("force","true"),await this.request(t.toString(),{method:"DELETE"})}async uploadMarkdownToStore(s,e){let t=await fetch(`${z}/${s}:uploadToFileSearchStore`,{method:"POST",headers:{"x-goog-api-key":this.apiKey,"X-Goog-Upload-Protocol":"resumable","X-Goog-Upload-Command":"start","X-Goog-Upload-Header-Content-Length":String(e.bytes.byteLength),"X-Goog-Upload-Header-Content-Type":"text/markdown","Content-Type":"application/json"},body:JSON.stringify({displayName:e.displayName,mimeType:"text/markdown",chunkingConfig:e.chunking?{whiteSpaceConfig:{maxTokensPerChunk:e.chunking.maxTokensPerChunk,maxOverlapTokens:e.chunking.maxOverlapTokens}}:void 0,customMetadata:e.metadata})});if(!t.ok)throw new Error(`Upload start failed: ${await t.text()}`);let i=t.headers.get("x-goog-upload-url");if(!i)throw new Error("Upload URL missing from response.");let n=await fetch(i,{method:"POST",headers:{"X-Goog-Upload-Command":"upload, finalize","X-Goog-Upload-Offset":"0"},body:e.bytes});if(!n.ok)throw new Error(`Upload finalize failed: ${await n.text()}`);return await n.json()}async waitForOperation(s,e=12e4){var i;let t=Date.now();for(;Date.now()-t<e;){let n=await this.request(`${O}/${s}`,{method:"GET"});if(n.done){if((i=n.error)!=null&&i.message)throw new Error(n.error.message);return}await this.delay(1e3)}throw new Error("Indexing timed out.")}async generateContent(s,e,t,i){return await this.request(`${O}/models/${s}:generateContent`,{method:"POST",body:JSON.stringify({contents:[{role:"user",parts:[{text:t}]}],tools:[{fileSearch:{fileSearchStoreNames:[e],metadataFilter:i||void 0}}]})})}extractAnswer(s){var r,d,l,h;let e=(r=s.candidates)==null?void 0:r[0],i=((l=(d=e==null?void 0:e.content)==null?void 0:d.parts)!=null?l:[]).map(o=>{var p;return(p=o.text)!=null?p:""}).join(""),n=(h=e==null?void 0:e.groundingMetadata)!=null?h:e==null?void 0:e.grounding_metadata;return{text:i,grounding:n}}async request(s,e){var i;let t=await fetch(s,{...e,headers:{"x-goog-api-key":this.apiKey,"Content-Type":"application/json",...(i=e.headers)!=null?i:{}}});if(!t.ok)throw new Error(await t.text());return t.status===204?{}:t.json()}async delay(s){return new Promise(e=>window.setTimeout(e,s))}};var b=require("obsidian");function J(a){var s,e;return(e=(s=a.stat)==null?void 0:s.mtime)!=null?e:0}async function I(a){let s=a.settings.apiKey,e=a.settings.storeName;if(!s){new b.Notice("API key is not set.");return}if(!e){new b.Notice("File Search store name is not set.");return}let t=a.app.vault.getMarkdownFiles(),i=new k(s),n={total:t.length,indexed:0,skipped:0,uploaded:0};a.setStatus(`Indexing ${t.length} files...`);let r=t.map(o=>({file:o,mtime:J(o)})).filter(({file:o,mtime:p})=>{var m,y;let g=(y=(m=a.indexState.files[o.path])==null?void 0:m.mtime)!=null?y:0;return p<=g?(n.skipped+=1,!1):!0}),h=(await Q(4,r,async({file:o,mtime:p})=>{try{let g=await Y(a,i,e,o,p);return n.uploaded+=1,a.setStatus(`Uploaded ${n.uploaded}/${n.total} (skipped ${n.skipped})`),{file:o,mtime:p,operationName:g==null?void 0:g.name,ok:!0}}catch(g){return console.error(g),new b.Notice(`Failed to upload ${o.path}`),{file:o,mtime:p,operationName:void 0,ok:!1}}})).filter(o=>o.operationName&&o.ok);h.length>0&&a.setStatus(`Finalizing ${h.length} uploads...`);for(let o of h)if(o.operationName)try{await i.waitForOperation(o.operationName),a.indexState.files[o.file.path]={mtime:o.mtime},n.indexed+=1,await a.saveSettings()}catch(p){console.error(p),new b.Notice(`Failed to finalize ${o.file.path}`)}a.setStatus(`Index complete. Indexed ${n.indexed}, uploaded ${n.uploaded}, skipped ${n.skipped}.`),new b.Notice(`Index complete. Indexed ${n.indexed}, uploaded ${n.uploaded}, skipped ${n.skipped}.`)}async function Y(a,s,e,t,i){let n=await a.app.vault.read(t),r=new TextEncoder().encode(n);if(r.byteLength>100*1024*1024)throw new Error(`File too large: ${t.path}`);let d=a.settings.chunkingEnabled?{maxTokensPerChunk:a.settings.maxTokensPerChunk,maxOverlapTokens:a.settings.maxOverlapTokens}:null,l=[{key:"vault",stringValue:a.app.vault.getName()},{key:"path",stringValue:t.path},{key:"mtime",numericValue:i}];return await s.uploadMarkdownToStore(e,{displayName:t.path,bytes:r,chunking:d,metadata:l})}async function Q(a,s,e){let t=[],i=0,n=async()=>{for(;i<s.length;){let d=i;i+=1;let l=s[d];t[d]=await e(l)}},r=Array.from({length:Math.min(a,s.length)},()=>n());return await Promise.all(r),t}var F=require("obsidian");async function L(a){var i,n;let s=a.settings.apiKey;if(!s){new F.Notice("API key is not set.");return}let e=a.settings.storeDisplayName||"obsidian-vault",t=new k(s);try{a.settings.storeName&&(a.setStatus("Deleting existing File Search store..."),await t.deleteFileSearchStore(a.settings.storeName,!0)),a.setStatus("Creating File Search store...");let r=await t.createFileSearchStore(e);a.settings.storeName=(i=r.name)!=null?i:"",await a.saveSettings(),new F.Notice(`Store created: ${(n=r.name)!=null?n:"unknown"}`)}catch(r){console.error(r),new F.Notice("Failed to create store. Check console for details.")}finally{a.setStatus("")}}var E="gemini-file-search-rag-view",D=class extends f.ItemView{constructor(e,t){super(e);this.sourcesMap=new Map;this.plugin=t}getViewType(){return E}getDisplayText(){return"Gemini RAG"}async onOpen(){this.render(),this.cleanupStatus=this.plugin.onStatusChange(e=>{this.statusEl&&(this.statusEl.setText(e),e?this.statusEl.addClass("is-active"):this.statusEl.removeClass("is-active"))})}async onClose(){this.cleanupStatus&&this.cleanupStatus()}render(){let{contentEl:e}=this;e.empty(),e.addClass("gemini-rag-view");let t=e.createEl("div",{cls:"gemini-rag-header"});t.createEl("div",{cls:"gemini-rag-title-wrap"}).createEl("h2",{text:"Gemini RAG"}),this.statusEl=t.createEl("div",{cls:"gemini-rag-status-pill"});let n=e.createEl("div",{cls:"gemini-rag-controls"});n.createEl("div",{cls:"gemini-rag-label"}).setText("Ask about your notes");let d=n.createEl("textarea",{cls:"gemini-rag-input",attr:{rows:"5",placeholder:"Ask something about your notes..."}});this.hintEl=n.createEl("div",{cls:"gemini-rag-hint"}),this.hintEl.setText("\u2318/Ctrl + Enter \u3067\u9001\u4FE1");let l=n.createEl("div",{cls:"gemini-rag-buttons"}),h=l.createEl("button",{cls:"gemini-rag-btn is-primary",text:"Ask"}),o=l.createEl("button",{cls:"gemini-rag-btn",text:"Index vault"}),p=l.createEl("button",{cls:"gemini-rag-btn",text:"Create store"}),g=async()=>{let c=d.value.trim();c&&await this.ask(c)};h.addEventListener("click",g),d.addEventListener("keydown",async c=>{(c.metaKey||c.ctrlKey)&&c.key==="Enter"&&(c.preventDefault(),await g())}),o.addEventListener("click",async()=>{await I(this.plugin)}),p.addEventListener("click",async()=>{await L(this.plugin)});let m=e.createEl("div",{cls:"gemini-rag-section"});m.createEl("h3",{text:"Answer"}),this.answerEl=m.createEl("div",{cls:"gemini-rag-answer"}),this.answerBodyEl=this.answerEl.createEl("div",{cls:"gemini-rag-answer-body"}),this.answerBodyEl.addEventListener("click",c=>{let v=c.target;if(!v)return;let x=v.closest("a");if(!x)return;let S=x.getAttribute("href");if(!S||!S.startsWith("citation:"))return;c.preventDefault();let T=S.replace("citation:",""),P=Number(T);if(!Number.isFinite(P))return;let R=this.sourcesMap.get(P);R&&this.openSource(R,!0)});let y=e.createEl("div",{cls:"gemini-rag-section"});y.createEl("h3",{text:"Sources"}),this.sourcesEl=y.createEl("div",{cls:"gemini-rag-sources"});let u=e.createEl("div",{cls:"gemini-rag-section"});u.createEl("h3",{text:"History"}),this.historyEl=u.createEl("div",{cls:"gemini-rag-history"}),this.renderHistory()}async ask(e){let t=this.plugin.settings.apiKey,i=this.plugin.settings.storeName,n=this.plugin.settings.model;if(!t){new f.Notice("API key is not set.");return}if(!i){new f.Notice("File Search store name is not set.");return}let r=new k(t);try{this.plugin.setStatus("Generating answer..."),this.statusEl&&(this.statusEl.setText("Thinking..."),this.statusEl.addClass("is-active")),this.answerBodyEl&&this.answerBodyEl.setText(""),this.sourcesEl&&this.sourcesEl.setText("");let d=await r.generateContent(n,i,e,this.plugin.settings.metadataFilter||void 0),{text:l,grounding:h}=r.extractAnswer(d),o=this.extractSources(h);this.sourcesMap.clear();for(let g of o)this.sourcesMap.set(g.index,g);let p=this.annotateAnswer(l,h,o);if(this.answerBodyEl&&(this.answerBodyEl.empty(),await f.MarkdownRenderer.renderMarkdown(p,this.answerBodyEl,this.plugin.app.vault.getRoot().path,this)),this.pushHistory(e,p),this.renderHistory(),this.sourcesEl)if(o.length===0)this.sourcesEl.createEl("div",{text:"No sources returned."});else{let g=this.sourcesEl.createEl("ol");for(let m of o)g.createEl("li").createEl("a",{text:`[${m.index}] ${m.label}`,cls:"gemini-rag-source-link"}).addEventListener("click",c=>{c.preventDefault(),this.openSource(m,!0)})}}catch(d){console.error(d),new f.Notice("Failed to generate answer. Check console for details.")}finally{this.plugin.setStatus(""),this.statusEl&&(this.statusEl.setText(""),this.statusEl.removeClass("is-active"))}}pushHistory(e,t){let i={id:`${Date.now()}-${Math.random().toString(16).slice(2)}`,timestamp:Date.now(),question:e,answer:t},n=30;this.plugin.history.unshift(i),this.plugin.history.length>n&&(this.plugin.history=this.plugin.history.slice(0,n)),this.plugin.saveSettings()}renderHistory(){if(this.historyEl){if(this.historyEl.empty(),!this.plugin.history.length){this.historyEl.createEl("div",{text:"No history yet."});return}for(let e of this.plugin.history){let t=this.historyEl.createEl("div",{cls:"gemini-rag-history-item"});t.createEl("div",{cls:"gemini-rag-history-question",text:e.question});let i=t.createEl("div",{cls:"gemini-rag-history-answer"});f.MarkdownRenderer.renderMarkdown(e.answer,i,this.plugin.app.vault.getRoot().path,this)}}}extractSources(e){return e!=null&&e.groundingChunks?e.groundingChunks.map((t,i)=>{var g,m,y,u,c;let n=(g=t.retrievedContext)!=null?g:t.retrieved_context,r=(y=(m=n==null?void 0:n.title)!=null?m:n==null?void 0:n.displayName)!=null?y:n==null?void 0:n.display_name,d=(u=n==null?void 0:n.uri)!=null?u:n==null?void 0:n.uri,l=(c=n==null?void 0:n.text)!=null?c:n==null?void 0:n.text,h=r||d||`Chunk ${i+1}`,o=l?l.slice(0,200):void 0,p=this.resolveVaultPath(r);return{label:h,detail:o,path:p,uri:d,index:i+1,text:l}}):[]}annotateAnswer(e,t,i){var h,o,p,g,m,y;if(!t)return e;let n=(o=(h=t.groundingSupports)!=null?h:t.grounding_supports)!=null?o:[];if(n.length===0)return e;let r=new Map;for(let u of n){let c=(p=u.segment)!=null?p:u.segment,v=(g=c==null?void 0:c.endIndex)!=null?g:c==null?void 0:c.end_index,x=(m=u.groundingChunkIndices)!=null?m:u.grounding_chunk_indices;if(typeof v!="number"||!Array.isArray(x))continue;let S=x.map(C=>{var N;return(N=i[C])==null?void 0:N.index}).filter(C=>typeof C=="number");if(S.length===0)continue;let T=Array.from(new Set(S)).sort((C,N)=>C-N),P=this.findSentenceEnd(e,v),R=(y=r.get(P))!=null?y:[];r.set(P,R.concat(T))}if(r.size===0)return e;let d=[];for(let[u,c]of r.entries()){let x=Array.from(new Set(c)).sort((S,T)=>S-T).map(S=>`[${S}](citation:${S})`).join(" ");d.push({pos:u,marker:` ${x}`})}d.sort((u,c)=>c.pos-u.pos);let l=e;for(let u of d)u.pos>=0&&u.pos<=l.length?l=l.slice(0,u.pos)+u.marker+l.slice(u.pos):l+=u.marker;return l}findSentenceEnd(e,t){if(t>=e.length)return e.length;let i=[".","!","?","\u3002","\uFF01","\uFF1F",`
`];for(let n=Math.max(0,t);n<e.length;n+=1){let r=e.charAt(n);if(i.includes(r))return n+1}return e.length}resolveVaultPath(e){if(!e)return;if(this.app.vault.getAbstractFileByPath(e))return e}async openSource(e,t){if(e.path){let i=this.app.vault.getAbstractFileByPath(e.path);if(i instanceof f.TFile){let n=this.app.workspace.getLeaf(!0);if(await n.openFile(i),t&&e.text){let r=n.view;r instanceof f.MarkdownView&&r.editor&&await this.highlightSnippet(r.editor,e.text)}return}}if(e.uri){if(e.uri.startsWith("obsidian://")){window.open(e.uri,"_blank");return}window.open(e.uri,"_blank")}}async highlightSnippet(e,t){let i=e.getValue(),n=t.trim();if(!n)return;let r=i.indexOf(n);if(r===-1)return;let d=e.offsetToPos(r),l=e.offsetToPos(r+n.length);e.setSelection(d,l),e.scrollIntoView({from:d,to:l},!0)}};async function M(a){let{workspace:s}=a.app,e=s.getLeavesOfType(E)[0];if(!e){let t=s.getRightLeaf(!1);e=t!=null?t:void 0,e||(e=s.getLeaf(!1)),await e.setViewState({type:E,active:!0})}await s.revealLeaf(e)}function _(a){a.addCommand({id:"open-gemini-rag-panel",name:"Open Gemini RAG panel",callback:()=>M(a)}),a.addCommand({id:"index-vault-to-file-search",name:"Index vault to File Search",callback:()=>I(a)}),a.addCommand({id:"create-file-search-store",name:"Create File Search store",callback:()=>L(a)})}var G={version:1,files:{}};var $=class extends B.Plugin{constructor(){super(...arguments);this.statusListeners=new Set}async onload(){await this.loadSettings(),this.registerView(E,e=>new D(e,this)),this.addSettingTab(new A(this.app,this)),_(this),this.app.workspace.onLayoutReady(()=>{M(this)})}onunload(){this.app.workspace.detachLeavesOfType(E)}setStatus(e){for(let t of this.statusListeners)t(e)}onStatusChange(e){return this.statusListeners.add(e),()=>{this.statusListeners.delete(e)}}async loadSettings(){var t,i;let e=await this.loadData();if(e&&"settings"in e){let n=e;this.settings=Object.assign({},V,(t=n.settings)!=null?t:{}),this.indexState=Object.assign({},G,(i=n.indexState)!=null?i:{}),this.history=Array.isArray(n.history)?n.history:[]}else{let n=e!=null?e:{};this.settings=Object.assign({},V,n),this.indexState=Object.assign({},G),this.history=[]}}async saveSettings(){let e={settings:this.settings,indexState:this.indexState,history:this.history};await this.saveData(e)}async resetIndexState(){this.indexState=Object.assign({},G),await this.saveSettings()}};
