/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

var G=Object.defineProperty;var K=Object.getOwnPropertyDescriptor;var j=Object.getOwnPropertyNames;var q=Object.prototype.hasOwnProperty;var W=(a,s)=>{for(var e in s)G(a,e,{get:s[e],enumerable:!0})},H=(a,s,e,t)=>{if(s&&typeof s=="object"||typeof s=="function")for(let i of j(s))!q.call(a,i)&&i!==e&&G(a,i,{get:()=>s[i],enumerable:!(t=K(s,i))||t.enumerable});return a};var X=a=>H(G({},"__esModule",{value:!0}),a);var Q={};W(Q,{default:()=>D});module.exports=X(Q);var $=require("obsidian");var f=require("obsidian"),M={apiKey:"",model:"gemini-2.5-flash",storeName:"",storeDisplayName:"obsidian-vault",metadataFilter:"",chunkingEnabled:!0,maxTokensPerChunk:200,maxOverlapTokens:20},R=class extends f.PluginSettingTab{constructor(s,e){super(s,e),this.plugin=e}display(){let{containerEl:s}=this;s.empty(),s.createEl("h2",{text:"Gemini RAG settings"}),new f.Setting(s).setName("API key").setDesc("Gemini API key. This plugin sends note contents to Google for indexing and answers.").addText(e=>{e.inputEl.type="password",e.setPlaceholder("AI Studio API key").setValue(this.plugin.settings.apiKey).onChange(async t=>{this.plugin.settings.apiKey=t.trim(),await this.plugin.saveSettings()})}),new f.Setting(s).setName("Model").setDesc("Model used for answering queries.").addText(e=>e.setPlaceholder("gemini-2.5-flash").setValue(this.plugin.settings.model).onChange(async t=>{this.plugin.settings.model=t.trim(),await this.plugin.saveSettings()})),new f.Setting(s).setName("File Search store name").setDesc("Full resource name, for example: fileSearchStores/1234567890").addText(e=>e.setPlaceholder("fileSearchStores/...").setValue(this.plugin.settings.storeName).onChange(async t=>{this.plugin.settings.storeName=t.trim(),await this.plugin.saveSettings()})),new f.Setting(s).setName("Store display name").setDesc("Used when creating a new store from the command palette.").addText(e=>e.setPlaceholder("obsidian-vault").setValue(this.plugin.settings.storeDisplayName).onChange(async t=>{this.plugin.settings.storeDisplayName=t.trim(),await this.plugin.saveSettings()})),new f.Setting(s).setName("Metadata filter").setDesc('Optional: filter sources by metadata (AIP-160 syntax). Example: author="Alice"').addText(e=>e.setPlaceholder('author="Alice"').setValue(this.plugin.settings.metadataFilter).onChange(async t=>{this.plugin.settings.metadataFilter=t.trim(),await this.plugin.saveSettings()})),new f.Setting(s).setName("Chunking config").setDesc("Use custom chunk sizes for File Search indexing (white-space chunking).").addToggle(e=>e.setValue(this.plugin.settings.chunkingEnabled).onChange(async t=>{this.plugin.settings.chunkingEnabled=t,await this.plugin.saveSettings()})),new f.Setting(s).setName("Max tokens per chunk").setDesc("Used when chunking is enabled. Default is 200.").addText(e=>e.setPlaceholder("200").setValue(String(this.plugin.settings.maxTokensPerChunk)).onChange(async t=>{let i=Number.parseInt(t,10);!Number.isNaN(i)&&i>0&&(this.plugin.settings.maxTokensPerChunk=i,await this.plugin.saveSettings())})),new f.Setting(s).setName("Max overlap tokens").setDesc("Used when chunking is enabled. Default is 20.").addText(e=>e.setPlaceholder("20").setValue(String(this.plugin.settings.maxOverlapTokens)).onChange(async t=>{let i=Number.parseInt(t,10);!Number.isNaN(i)&&i>=0&&(this.plugin.settings.maxOverlapTokens=i,await this.plugin.saveSettings())})),new f.Setting(s).setName("Reset local index state").setDesc("Clears local index tracking. This does not delete remote documents.").addButton(e=>e.setButtonText("Reset").onClick(async()=>{await this.plugin.resetIndexState()}))}};var w=require("obsidian");var V="https://generativelanguage.googleapis.com/v1beta",z="https://generativelanguage.googleapis.com/upload/v1beta",x=class{constructor(s){this.apiKey=s}async createFileSearchStore(s){return await this.request(`${V}/fileSearchStores`,{method:"POST",body:JSON.stringify({displayName:s})})}async uploadMarkdownToStore(s,e){let t=await fetch(`${z}/${s}:uploadToFileSearchStore`,{method:"POST",headers:{"x-goog-api-key":this.apiKey,"X-Goog-Upload-Protocol":"resumable","X-Goog-Upload-Command":"start","X-Goog-Upload-Header-Content-Length":String(e.bytes.byteLength),"X-Goog-Upload-Header-Content-Type":"text/markdown","Content-Type":"application/json"},body:JSON.stringify({displayName:e.displayName,mimeType:"text/markdown",chunkingConfig:e.chunking?{whiteSpaceConfig:{maxTokensPerChunk:e.chunking.maxTokensPerChunk,maxOverlapTokens:e.chunking.maxOverlapTokens}}:void 0,customMetadata:e.metadata})});if(!t.ok)throw new Error(`Upload start failed: ${await t.text()}`);let i=t.headers.get("x-goog-upload-url");if(!i)throw new Error("Upload URL missing from response.");let n=await fetch(i,{method:"POST",headers:{"X-Goog-Upload-Command":"upload, finalize","X-Goog-Upload-Offset":"0"},body:e.bytes});if(!n.ok)throw new Error(`Upload finalize failed: ${await n.text()}`);return await n.json()}async waitForOperation(s,e=12e4){var i;let t=Date.now();for(;Date.now()-t<e;){let n=await this.request(`${V}/${s}`,{method:"GET"});if(n.done){if((i=n.error)!=null&&i.message)throw new Error(n.error.message);return}await this.delay(1e3)}throw new Error("Indexing timed out.")}async generateContent(s,e,t,i){return await this.request(`${V}/models/${s}:generateContent`,{method:"POST",body:JSON.stringify({contents:[{role:"user",parts:[{text:t}]}],tools:[{fileSearch:{fileSearchStoreNames:[e],metadataFilter:i||void 0}}]})})}extractAnswer(s){var r,c,o,d;let e=(r=s.candidates)==null?void 0:r[0],i=((o=(c=e==null?void 0:e.content)==null?void 0:c.parts)!=null?o:[]).map(g=>{var m;return(m=g.text)!=null?m:""}).join(""),n=(d=e==null?void 0:e.groundingMetadata)!=null?d:e==null?void 0:e.grounding_metadata;return{text:i,grounding:n}}async request(s,e){var i;let t=await fetch(s,{...e,headers:{"x-goog-api-key":this.apiKey,"Content-Type":"application/json",...(i=e.headers)!=null?i:{}}});if(!t.ok)throw new Error(await t.text());return t.status===204?{}:t.json()}async delay(s){return new Promise(e=>window.setTimeout(e,s))}};var C=require("obsidian");function J(a){var s,e;return(e=(s=a.stat)==null?void 0:s.mtime)!=null?e:0}async function N(a){var r,c;let s=a.settings.apiKey,e=a.settings.storeName;if(!s){new C.Notice("API key is not set.");return}if(!e){new C.Notice("File Search store name is not set.");return}let t=a.app.vault.getMarkdownFiles(),i=new x(s),n={total:t.length,indexed:0,skipped:0};a.setStatus(`Indexing ${t.length} files...`);for(let o of t){let d=J(o),g=(c=(r=a.indexState.files[o.path])==null?void 0:r.mtime)!=null?c:0;if(d<=g){n.skipped+=1;continue}try{await Y(a,i,e,o,d),a.indexState.files[o.path]={mtime:d},n.indexed+=1,a.setStatus(`Indexed ${n.indexed}/${n.total} (skipped ${n.skipped})`),await a.saveSettings()}catch(m){console.error(m),new C.Notice(`Failed to index ${o.path}`)}}a.setStatus(`Index complete. Indexed ${n.indexed}, skipped ${n.skipped}.`),new C.Notice(`Index complete. Indexed ${n.indexed}, skipped ${n.skipped}.`)}async function Y(a,s,e,t,i){let n=await a.app.vault.read(t),r=new TextEncoder().encode(n);if(r.byteLength>100*1024*1024)throw new Error(`File too large: ${t.path}`);let c=a.settings.chunkingEnabled?{maxTokensPerChunk:a.settings.maxTokensPerChunk,maxOverlapTokens:a.settings.maxOverlapTokens}:null,o=[{key:"vault",stringValue:a.app.vault.getName()},{key:"path",stringValue:t.path},{key:"mtime",numericValue:i}],d=await s.uploadMarkdownToStore(e,{displayName:t.path,bytes:r,chunking:c,metadata:o});d!=null&&d.name&&await s.waitForOperation(d.name)}var O=require("obsidian");async function I(a){var i,n;let s=a.settings.apiKey;if(!s){new O.Notice("API key is not set.");return}let e=a.settings.storeDisplayName||"obsidian-vault",t=new x(s);try{a.setStatus("Creating File Search store...");let r=await t.createFileSearchStore(e);a.settings.storeName=(i=r.name)!=null?i:"",await a.saveSettings(),new O.Notice(`Store created: ${(n=r.name)!=null?n:"unknown"}`)}catch(r){console.error(r),new O.Notice("Failed to create store. Check console for details.")}finally{a.setStatus("")}}var E="gemini-file-search-rag-view",F=class extends w.ItemView{constructor(e,t){super(e);this.sourcesMap=new Map;this.plugin=t}getViewType(){return E}getDisplayText(){return"Gemini RAG"}async onOpen(){this.render(),this.cleanupStatus=this.plugin.onStatusChange(e=>{this.statusEl&&(this.statusEl.setText(e),e?this.statusEl.addClass("is-active"):this.statusEl.removeClass("is-active"))})}async onClose(){this.cleanupStatus&&this.cleanupStatus()}render(){let{contentEl:e}=this;e.empty(),e.addClass("gemini-rag-view");let t=e.createEl("div",{cls:"gemini-rag-header"});t.createEl("div",{cls:"gemini-rag-title-wrap"}).createEl("h2",{text:"Gemini RAG"}),this.statusEl=t.createEl("div",{cls:"gemini-rag-status-pill"});let n=e.createEl("div",{cls:"gemini-rag-controls"});n.createEl("div",{cls:"gemini-rag-label"}).setText("Ask about your notes");let c=n.createEl("textarea",{cls:"gemini-rag-input",attr:{rows:"5",placeholder:"Ask something about your notes..."}});this.hintEl=n.createEl("div",{cls:"gemini-rag-hint"}),this.hintEl.setText("\u2318/Ctrl + Enter \u3067\u9001\u4FE1");let o=n.createEl("div",{cls:"gemini-rag-buttons"}),d=o.createEl("button",{cls:"gemini-rag-btn is-primary",text:"Ask"}),g=o.createEl("button",{cls:"gemini-rag-btn",text:"Index vault"}),m=o.createEl("button",{cls:"gemini-rag-btn",text:"Create store"}),h=async()=>{let l=c.value.trim();l&&await this.ask(l)};d.addEventListener("click",h),c.addEventListener("keydown",async l=>{(l.metaKey||l.ctrlKey)&&l.key==="Enter"&&(l.preventDefault(),await h())}),g.addEventListener("click",async()=>{await N(this.plugin)}),m.addEventListener("click",async()=>{await I(this.plugin)});let p=e.createEl("div",{cls:"gemini-rag-section"});p.createEl("h3",{text:"Answer"}),this.answerEl=p.createEl("div",{cls:"gemini-rag-answer"}),this.answerBodyEl=this.answerEl.createEl("div",{cls:"gemini-rag-answer-body"}),this.answerBodyEl.addEventListener("click",l=>{let u=l.target;if(!u)return;let v=u.closest("a");if(!v)return;let S=v.getAttribute("href");if(!S||!S.startsWith("citation:"))return;l.preventDefault();let k=S.replace("citation:",""),b=Number(k);if(!Number.isFinite(b))return;let T=this.sourcesMap.get(b);T&&this.openSource(T,!0)});let y=e.createEl("div",{cls:"gemini-rag-section"});y.createEl("h3",{text:"Sources"}),this.sourcesEl=y.createEl("div",{cls:"gemini-rag-sources"})}async ask(e){let t=this.plugin.settings.apiKey,i=this.plugin.settings.storeName,n=this.plugin.settings.model;if(!t){new w.Notice("API key is not set.");return}if(!i){new w.Notice("File Search store name is not set.");return}let r=new x(t);try{this.plugin.setStatus("Generating answer..."),this.statusEl&&(this.statusEl.setText("Thinking..."),this.statusEl.addClass("is-active")),this.answerBodyEl&&this.answerBodyEl.setText(""),this.sourcesEl&&this.sourcesEl.setText("");let c=await r.generateContent(n,i,e,this.plugin.settings.metadataFilter||void 0),{text:o,grounding:d}=r.extractAnswer(c),g=this.extractSources(d);this.sourcesMap.clear();for(let h of g)this.sourcesMap.set(h.index,h);let m=this.annotateAnswer(o,d,g);if(this.answerBodyEl&&(this.answerBodyEl.empty(),await w.MarkdownRenderer.renderMarkdown(m,this.answerBodyEl,this.plugin.app.vault.getRoot().path,this)),this.sourcesEl)if(g.length===0)this.sourcesEl.createEl("div",{text:"No sources returned."});else{let h=this.sourcesEl.createEl("ol");for(let p of g){let y=h.createEl("li");y.createEl("a",{text:`[${p.index}] ${p.label}`,cls:"gemini-rag-source-link"}).addEventListener("click",u=>{u.preventDefault(),this.openSource(p,!0)}),p.detail&&y.createEl("div",{text:p.detail,cls:"gemini-rag-source-detail"})}}}catch(c){console.error(c),new w.Notice("Failed to generate answer. Check console for details.")}finally{this.plugin.setStatus(""),this.statusEl&&(this.statusEl.setText(""),this.statusEl.removeClass("is-active"))}}extractSources(e){return e!=null&&e.groundingChunks?e.groundingChunks.map((t,i)=>{var h,p,y,l,u;let n=(h=t.retrievedContext)!=null?h:t.retrieved_context,r=(y=(p=n==null?void 0:n.title)!=null?p:n==null?void 0:n.displayName)!=null?y:n==null?void 0:n.display_name,c=(l=n==null?void 0:n.uri)!=null?l:n==null?void 0:n.uri,o=(u=n==null?void 0:n.text)!=null?u:n==null?void 0:n.text,d=r||c||`Chunk ${i+1}`,g=o?o.slice(0,200):void 0,m=this.resolveVaultPath(r);return{label:d,detail:g,path:m,uri:c,index:i+1,text:o}}):[]}annotateAnswer(e,t,i){var d,g,m,h,p,y;if(!t)return e;let n=(g=(d=t.groundingSupports)!=null?d:t.grounding_supports)!=null?g:[];if(n.length===0)return e;let r=new Map;for(let l of n){let u=(m=l.segment)!=null?m:l.segment,v=(h=u==null?void 0:u.endIndex)!=null?h:u==null?void 0:u.end_index,S=(p=l.groundingChunkIndices)!=null?p:l.grounding_chunk_indices;if(typeof v!="number"||!Array.isArray(S))continue;let k=S.map(P=>{var A;return(A=i[P])==null?void 0:A.index}).filter(P=>typeof P=="number");if(k.length===0)continue;let b=Array.from(new Set(k)).sort((P,A)=>P-A),T=this.findSentenceEnd(e,v),B=(y=r.get(T))!=null?y:[];r.set(T,B.concat(b))}if(r.size===0)return e;let c=[];for(let[l,u]of r.entries()){let S=Array.from(new Set(u)).sort((k,b)=>k-b).map(k=>`[${k}](citation:${k})`).join(" ");c.push({pos:l,marker:` ${S}`})}c.sort((l,u)=>u.pos-l.pos);let o=e;for(let l of c)l.pos>=0&&l.pos<=o.length?o=o.slice(0,l.pos)+l.marker+o.slice(l.pos):o+=l.marker;return o}findSentenceEnd(e,t){if(t>=e.length)return e.length;let i=[".","!","?","\u3002","\uFF01","\uFF1F",`
`];for(let n=Math.max(0,t);n<e.length;n+=1){let r=e.charAt(n);if(i.includes(r))return n+1}return e.length}resolveVaultPath(e){if(!e)return;if(this.app.vault.getAbstractFileByPath(e))return e}async openSource(e,t){if(e.path){let i=this.app.vault.getAbstractFileByPath(e.path);if(i instanceof w.TFile){let n=this.app.workspace.getLeaf(!0);if(await n.openFile(i),t&&e.text){let r=n.view;r instanceof w.MarkdownView&&r.editor&&await this.highlightSnippet(r.editor,e.text)}return}}if(e.uri){if(e.uri.startsWith("obsidian://")){window.open(e.uri,"_blank");return}window.open(e.uri,"_blank")}}async highlightSnippet(e,t){let i=e.getValue(),n=t.trim();if(!n)return;let r=i.indexOf(n);if(r===-1)return;let c=e.offsetToPos(r),o=e.offsetToPos(r+n.length);e.setSelection(c,o),e.scrollIntoView({from:c,to:o},!0)}};async function U(a){let{workspace:s}=a.app,e=s.getLeavesOfType(E)[0];if(!e){let t=s.getRightLeaf(!1);e=t!=null?t:void 0,e||(e=s.getLeaf(!1)),await e.setViewState({type:E,active:!0})}await s.revealLeaf(e)}function _(a){a.addCommand({id:"open-gemini-rag-panel",name:"Open Gemini RAG panel",callback:()=>U(a)}),a.addCommand({id:"index-vault-to-file-search",name:"Index vault to File Search",callback:()=>N(a)}),a.addCommand({id:"create-file-search-store",name:"Create File Search store",callback:()=>I(a)})}var L={version:1,files:{}};var D=class extends $.Plugin{constructor(){super(...arguments);this.statusListeners=new Set}async onload(){await this.loadSettings(),this.registerView(E,e=>new F(e,this)),this.addSettingTab(new R(this.app,this)),_(this)}onunload(){this.app.workspace.detachLeavesOfType(E)}setStatus(e){for(let t of this.statusListeners)t(e)}onStatusChange(e){return this.statusListeners.add(e),()=>{this.statusListeners.delete(e)}}async loadSettings(){var t,i;let e=await this.loadData();if(e&&"settings"in e){let n=e;this.settings=Object.assign({},M,(t=n.settings)!=null?t:{}),this.indexState=Object.assign({},L,(i=n.indexState)!=null?i:{})}else{let n=e!=null?e:{};this.settings=Object.assign({},M,n),this.indexState=Object.assign({},L)}}async saveSettings(){let e={settings:this.settings,indexState:this.indexState};await this.saveData(e)}async resetIndexState(){this.indexState=Object.assign({},L),await this.saveSettings()}};
