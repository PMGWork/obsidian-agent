/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

var P=Object.defineProperty;var G=Object.getOwnPropertyDescriptor;var L=Object.getOwnPropertyNames;var F=Object.prototype.hasOwnProperty;var D=(a,t)=>{for(var e in t)P(a,e,{get:t[e],enumerable:!0})},U=(a,t,e,n)=>{if(t&&typeof t=="object"||typeof t=="function")for(let s of L(t))!F.call(a,s)&&s!==e&&P(a,s,{get:()=>t[s],enumerable:!(n=G(t,s))||n.enumerable});return a};var $=a=>U(P({},"__esModule",{value:!0}),a);var V={};D(V,{default:()=>k});module.exports=$(V);var A=require("obsidian");var p=require("obsidian"),T={apiKey:"",model:"gemini-2.5-flash",storeName:"",storeDisplayName:"obsidian-vault"},S=class extends p.PluginSettingTab{constructor(t,e){super(t,e),this.plugin=e}display(){let{containerEl:t}=this;t.empty(),t.createEl("h2",{text:"Gemini RAG settings"}),new p.Setting(t).setName("API key").setDesc("Gemini API key. This plugin sends note contents to Google for indexing and answers.").addText(e=>{e.inputEl.type="password",e.setPlaceholder("AI Studio API key").setValue(this.plugin.settings.apiKey).onChange(async n=>{this.plugin.settings.apiKey=n.trim(),await this.plugin.saveSettings()})}),new p.Setting(t).setName("Model").setDesc("Model used for answering queries.").addText(e=>e.setPlaceholder("gemini-2.5-flash").setValue(this.plugin.settings.model).onChange(async n=>{this.plugin.settings.model=n.trim(),await this.plugin.saveSettings()})),new p.Setting(t).setName("File Search store name").setDesc("Full resource name, for example: fileSearchStores/1234567890").addText(e=>e.setPlaceholder("fileSearchStores/...").setValue(this.plugin.settings.storeName).onChange(async n=>{this.plugin.settings.storeName=n.trim(),await this.plugin.saveSettings()})),new p.Setting(t).setName("Store display name").setDesc("Used when creating a new store from the command palette.").addText(e=>e.setPlaceholder("obsidian-vault").setValue(this.plugin.settings.storeDisplayName).onChange(async n=>{this.plugin.settings.storeDisplayName=n.trim(),await this.plugin.saveSettings()})),new p.Setting(t).setName("Reset local index state").setDesc("Clears local index tracking. This does not delete remote documents.").addButton(e=>e.setButtonText("Reset").onClick(async()=>{await this.plugin.resetIndexState()}))}};var h=require("obsidian");var C="https://generativelanguage.googleapis.com/v1beta",_="https://generativelanguage.googleapis.com/upload/v1beta",m=class{constructor(t){this.apiKey=t}async createFileSearchStore(t){return await this.request(`${C}/fileSearchStores`,{method:"POST",body:JSON.stringify({displayName:t})})}async uploadMarkdownToStore(t,e){let n=await fetch(`${_}/${t}:uploadToFileSearchStore`,{method:"POST",headers:{"x-goog-api-key":this.apiKey,"X-Goog-Upload-Protocol":"resumable","X-Goog-Upload-Command":"start","X-Goog-Upload-Header-Content-Length":String(e.bytes.byteLength),"X-Goog-Upload-Header-Content-Type":"text/markdown","Content-Type":"application/json"},body:JSON.stringify({displayName:e.displayName,mimeType:"text/markdown"})});if(!n.ok)throw new Error(`Upload start failed: ${await n.text()}`);let s=n.headers.get("x-goog-upload-url");if(!s)throw new Error("Upload URL missing from response.");let i=await fetch(s,{method:"POST",headers:{"X-Goog-Upload-Command":"upload, finalize","X-Goog-Upload-Offset":"0"},body:e.bytes});if(!i.ok)throw new Error(`Upload finalize failed: ${await i.text()}`);return await i.json()}async waitForOperation(t,e=12e4){var s;let n=Date.now();for(;Date.now()-n<e;){let i=await this.request(`${C}/${t}`,{method:"GET"});if(i.done){if((s=i.error)!=null&&s.message)throw new Error(i.error.message);return}await this.delay(1e3)}throw new Error("Indexing timed out.")}async generateContent(t,e,n){return await this.request(`${C}/models/${t}:generateContent`,{method:"POST",body:JSON.stringify({contents:[{role:"user",parts:[{text:n}]}],tools:[{fileSearch:{fileSearchStoreNames:[e]}}]})})}extractAnswer(t){var r,d,o,l;let e=(r=t.candidates)==null?void 0:r[0],s=((o=(d=e==null?void 0:e.content)==null?void 0:d.parts)!=null?o:[]).map(g=>{var c;return(c=g.text)!=null?c:""}).join(""),i=(l=e==null?void 0:e.groundingMetadata)!=null?l:e==null?void 0:e.grounding_metadata;return{text:s,grounding:i}}async request(t,e){var s;let n=await fetch(t,{...e,headers:{"x-goog-api-key":this.apiKey,"Content-Type":"application/json",...(s=e.headers)!=null?s:{}}});if(!n.ok)throw new Error(await n.text());return n.status===204?{}:n.json()}async delay(t){return new Promise(e=>window.setTimeout(e,t))}};var w=require("obsidian");function M(a){var t,e;return(e=(t=a.stat)==null?void 0:t.mtime)!=null?e:0}async function y(a){var r,d;let t=a.settings.apiKey,e=a.settings.storeName;if(!t){new w.Notice("API key is not set.");return}if(!e){new w.Notice("File Search store name is not set.");return}let n=a.app.vault.getMarkdownFiles(),s=new m(t),i={total:n.length,indexed:0,skipped:0};a.setStatus(`Indexing ${n.length} files...`);for(let o of n){let l=M(o),g=(d=(r=a.indexState.files[o.path])==null?void 0:r.mtime)!=null?d:0;if(l<=g){i.skipped+=1;continue}try{await K(a,s,e,o),a.indexState.files[o.path]={mtime:l},i.indexed+=1,a.setStatus(`Indexed ${i.indexed}/${i.total} (skipped ${i.skipped})`),await a.saveSettings()}catch(c){console.error(c),new w.Notice(`Failed to index ${o.path}`)}}a.setStatus(`Index complete. Indexed ${i.indexed}, skipped ${i.skipped}.`),new w.Notice(`Index complete. Indexed ${i.indexed}, skipped ${i.skipped}.`)}async function K(a,t,e,n){let s=await a.app.vault.read(n),i=new TextEncoder().encode(s);if(i.byteLength>100*1024*1024)throw new Error(`File too large: ${n.path}`);let r=await t.uploadMarkdownToStore(e,{displayName:n.name,bytes:i});r!=null&&r.name&&await t.waitForOperation(r.name)}var x=require("obsidian");async function E(a){var s,i;let t=a.settings.apiKey;if(!t){new x.Notice("API key is not set.");return}let e=a.settings.storeDisplayName||"obsidian-vault",n=new m(t);try{a.setStatus("Creating File Search store...");let r=await n.createFileSearchStore(e);a.settings.storeName=(s=r.name)!=null?s:"",await a.saveSettings(),new x.Notice(`Store created: ${(i=r.name)!=null?i:"unknown"}`)}catch(r){console.error(r),new x.Notice("Failed to create store. Check console for details.")}finally{a.setStatus("")}}var u="gemini-file-search-rag-view",v=class extends h.ItemView{constructor(t,e){super(t),this.plugin=e}getViewType(){return u}getDisplayText(){return"Gemini RAG"}async onOpen(){this.render(),this.cleanupStatus=this.plugin.onStatusChange(t=>{this.statusEl&&this.statusEl.setText(t)})}async onClose(){this.cleanupStatus&&this.cleanupStatus()}render(){let{contentEl:t}=this;t.empty(),t.addClass("gemini-rag-view");let e=t.createEl("div",{cls:"gemini-rag-header"});e.createEl("h2",{text:"Gemini RAG"}),this.statusEl=e.createEl("div",{cls:"gemini-rag-status"});let n=t.createEl("div",{cls:"gemini-rag-controls"}),s=n.createEl("textarea",{cls:"gemini-rag-input",attr:{rows:"4",placeholder:"Ask something about your notes..."}}),i=n.createEl("div",{cls:"gemini-rag-buttons"}),r=i.createEl("button",{text:"Ask"}),d=i.createEl("button",{text:"Index vault"}),o=i.createEl("button",{text:"Create store"});r.addEventListener("click",async()=>{let l=s.value.trim();l&&await this.ask(l)}),d.addEventListener("click",async()=>{await y(this.plugin)}),o.addEventListener("click",async()=>{await E(this.plugin)}),this.answerEl=t.createEl("div",{cls:"gemini-rag-answer"}),this.sourcesEl=t.createEl("div",{cls:"gemini-rag-sources"})}async ask(t){let e=this.plugin.settings.apiKey,n=this.plugin.settings.storeName,s=this.plugin.settings.model;if(!e){new h.Notice("API key is not set.");return}if(!n){new h.Notice("File Search store name is not set.");return}let i=new m(e);try{this.plugin.setStatus("Generating answer..."),this.answerEl&&this.answerEl.setText(""),this.sourcesEl&&this.sourcesEl.setText("");let r=await i.generateContent(s,n,t),{text:d,grounding:o}=i.extractAnswer(r);this.answerEl&&(this.answerEl.createEl("h3",{text:"Answer"}),this.answerEl.createEl("div",{text:d}));let l=this.extractSources(o);if(this.sourcesEl)if(this.sourcesEl.createEl("h3",{text:"Sources"}),l.length===0)this.sourcesEl.createEl("div",{text:"No sources returned."});else{let g=this.sourcesEl.createEl("ol");for(let c of l){let f=g.createEl("li");f.createEl("div",{text:c.label}),c.detail&&f.createEl("div",{text:c.detail,cls:"gemini-rag-source-detail"})}}}catch(r){console.error(r),new h.Notice("Failed to generate answer. Check console for details.")}finally{this.plugin.setStatus("")}}extractSources(t){return t!=null&&t.groundingChunks?t.groundingChunks.map((e,n)=>{var g,c,f,R,N;let s=(g=e.retrievedContext)!=null?g:e.retrieved_context,i=(f=(c=s==null?void 0:s.title)!=null?c:s==null?void 0:s.displayName)!=null?f:s==null?void 0:s.display_name,r=(R=s==null?void 0:s.uri)!=null?R:s==null?void 0:s.uri,d=(N=s==null?void 0:s.text)!=null?N:s==null?void 0:s.text,o=i||r||`Chunk ${n+1}`,l=d?d.slice(0,200):void 0;return{label:o,detail:l}}):[]}};async function O(a){let{workspace:t}=a.app,e=t.getLeavesOfType(u)[0];e||(e=t.getRightLeaf(!1),e||(e=t.getLeaf(!1)),await e.setViewState({type:u,active:!0})),t.revealLeaf(e)}function I(a){a.addCommand({id:"open-gemini-rag-panel",name:"Open Gemini RAG panel",callback:()=>O(a)}),a.addCommand({id:"index-vault-to-file-search",name:"Index vault to File Search",callback:()=>y(a)}),a.addCommand({id:"create-file-search-store",name:"Create File Search store",callback:()=>E(a)})}var b={version:1,files:{}};var k=class extends A.Plugin{constructor(){super(...arguments);this.statusListeners=new Set}async onload(){await this.loadSettings(),this.registerView(u,e=>new v(e,this)),this.addSettingTab(new S(this.app,this)),I(this)}onunload(){this.app.workspace.detachLeavesOfType(u)}setStatus(e){for(let n of this.statusListeners)n(e)}onStatusChange(e){return this.statusListeners.add(e),()=>{this.statusListeners.delete(e)}}async loadSettings(){var n,s;let e=await this.loadData();if(e&&"settings"in e){let i=e;this.settings=Object.assign({},T,(n=i.settings)!=null?n:{}),this.indexState=Object.assign({},b,(s=i.indexState)!=null?s:{})}else{let i=e!=null?e:{};this.settings=Object.assign({},T,i),this.indexState=Object.assign({},b)}}async saveSettings(){let e={settings:this.settings,indexState:this.indexState};await this.saveData(e)}async resetIndexState(){this.indexState=Object.assign({},b),await this.saveSettings()}};
